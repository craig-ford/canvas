# specs/002-canvas-management/tasks/T-002.md

## Task: Attachment Service Contract Tests

## Type
contract-test

## Context
- **Phase**: Contracts & Interfaces
- **Builds on**: None
- **Blocks**: T-011, T-013
- **Requirements**: FR-001, FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/models/__init__.py | 001A-infrastructure/T-006 | `from canvas.models import TimestampMixin` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| None | None | None |

## Scope
- **CREATE**: `backend/canvas/services/attachment_service.py`
- **CREATE**: `tests/canvas/test_attachment_service_contract.py`

## Contract
```python
from abc import ABC, abstractmethod
from typing import Optional, List
from uuid import UUID
from pathlib import Path
from fastapi import UploadFile
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.attachment import Attachment

class AttachmentServiceInterface(ABC):
    @abstractmethod
    async def upload_file(self, file: UploadFile, vbu_id: UUID, proof_point_id: Optional[UUID], 
                         monthly_review_id: Optional[UUID], uploaded_by: UUID, 
                         label: Optional[str], db: AsyncSession) -> Attachment:
        """Upload file with validation and storage."""
        ...
    
    @abstractmethod
    async def get_attachment(self, attachment_id: UUID, db: AsyncSession) -> Optional[Attachment]:
        """Get attachment by ID."""
        ...
    
    @abstractmethod
    async def delete_attachment(self, attachment_id: UUID, db: AsyncSession) -> None:
        """Delete attachment from database and filesystem."""
        ...
    
    @abstractmethod
    async def validate_file(self, file: UploadFile) -> None:
        """Validate file size and content type."""
        ...
    
    @abstractmethod
    def generate_storage_path(self, vbu_id: UUID, entity_type: str, filename: str) -> str:
        """Generate unique storage path for file."""
        ...
    
    @abstractmethod
    async def cleanup_orphaned_files(self, db: AsyncSession) -> int:
        """Remove files without database records."""
        ...

class AttachmentService(AttachmentServiceInterface):
    """File attachment service implementation."""
    
    def __init__(self, upload_dir: str = "/uploads", max_size_mb: int = 10):
        self.upload_dir = Path(upload_dir)
        self.max_size_bytes = max_size_mb * 1024 * 1024
        self.allowed_types = {
            "image/png", "image/jpeg", "image/gif",
            "application/pdf", "text/csv",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        }
    
    async def upload_file(self, file: UploadFile, vbu_id: UUID, proof_point_id: Optional[UUID],
                         monthly_review_id: Optional[UUID], uploaded_by: UUID,
                         label: Optional[str], db: AsyncSession) -> Attachment:
        ...
    
    async def get_attachment(self, attachment_id: UUID, db: AsyncSession) -> Optional[Attachment]:
        ...
    
    async def delete_attachment(self, attachment_id: UUID, db: AsyncSession) -> None:
        ...
    
    async def validate_file(self, file: UploadFile) -> None:
        ...
    
    def generate_storage_path(self, vbu_id: UUID, entity_type: str, filename: str) -> str:
        ...
    
    async def cleanup_orphaned_files(self, db: AsyncSession) -> int:
        ...
```

## Logic
1. Define AttachmentServiceInterface with file operations
2. Create AttachmentService class with configuration
3. Write contract tests for interface compliance
4. Test file validation rules (size, type)
5. Test storage path generation patterns
6. Verify error handling for invalid files

## Verification
- [ ] Interface defines all file operations
- [ ] Service class implements interface
- [ ] Contract tests verify method signatures
- [ ] File validation tests contain assertions
- [ ] Storage path tests verify format

## LOC Estimate
~120 lines