# specs/002-canvas-management/tasks/T-008.md

## Task: Canvas Service Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: None
- **Blocks**: T-012 (CanvasService Implementation)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/auth/dependencies.py | 001-auth/T-015 | `from auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/services/canvas_service.py | CanvasService interface |
| T-003 | backend/canvas/models/ | Canvas, VBU, Thesis, ProofPoint models |

## Scope
- **CREATE**: `backend/tests/test_canvas_service.py`

## Contract
```python
class TestCanvasService:
    """Test canvas operations, nested data loading, currently testing pointer."""
    
    async def test_get_canvas_by_vbu_with_nested_data(self, db_session, sample_canvas):
        """Get canvas loads all nested theses and proof points."""
        assert result.id == sample_canvas.id
        assert len(result.theses) == 2
        assert len(result.theses[0].proof_points) == 1
    
    async def test_get_canvas_nonexistent_vbu(self, db_session):
        """Getting canvas for nonexistent VBU raises NotFoundError."""
        with pytest.raises(NotFoundError):
            ...
    
    async def test_update_canvas_basic_fields(self, db_session, gm_user, sample_canvas):
        """Update canvas basic fields with authorization."""
        assert result.product_name == "Updated Product"
        assert result.lifecycle_lane == LifecycleLane.SELL
        assert result.updated_by == gm_user.id
    
    async def test_update_canvas_portfolio_notes_as_admin(self, db_session, admin_user, sample_canvas):
        """Admin can update portfolio notes field."""
        assert result.portfolio_notes == "Admin notes"
    
    async def test_update_canvas_portfolio_notes_as_gm_ignored(self, db_session, gm_user, sample_canvas):
        """GM portfolio notes update is ignored, no error."""
        assert result.portfolio_notes is None  # Field ignored
    
    async def test_update_currently_testing_thesis(self, db_session, sample_canvas, sample_thesis):
        """Update currently testing pointer to thesis."""
        assert result.currently_testing_type == CurrentlyTestingType.THESIS
        assert result.currently_testing_id == sample_thesis.id
    
    async def test_update_currently_testing_proof_point(self, db_session, sample_canvas, sample_proof_point):
        """Update currently testing pointer to proof point."""
        assert result.currently_testing_type == CurrentlyTestingType.PROOF_POINT
        assert result.currently_testing_id == sample_proof_point.id
    
    async def test_update_currently_testing_invalid_id(self, db_session, sample_canvas):
        """Invalid currently testing ID raises ValidationError."""
        with pytest.raises(ValidationError):
            ...
    
    async def test_update_currently_testing_clear(self, db_session, sample_canvas):
        """Clear currently testing pointer (set to None)."""
        assert result.currently_testing_type is None
        assert result.currently_testing_id is None
    
    async def test_canvas_authorization_gm_own_vbu(self, db_session, gm_user, sample_canvas):
        """GM can access their own VBU's canvas."""
        assert result.id == sample_canvas.id
    
    async def test_canvas_authorization_gm_other_vbu(self, db_session, gm_user, other_canvas):
        """GM cannot access other GM's canvas."""
        with pytest.raises(ForbiddenError):
            ...
    
    async def test_canvas_max_theses_constraint(self, db_session, sample_canvas):
        """Canvas enforces max 5 theses constraint."""
        # Create 5 theses, attempt 6th
        with pytest.raises(ValidationError, match="Maximum 5 theses"):
            ...
```

## Logic
1. Import CanvasService, models, auth dependencies
2. Define test fixtures for canvas with nested data
3. Test canvas retrieval with nested loading
4. Test canvas updates with field validation
5. Test portfolio notes admin-only access
6. Test currently testing pointer operations
7. Test referential integrity for currently testing
8. Test authorization for canvas access
9. Test business rule constraints (max theses)

## Verification
- [ ] All test methods contain assertions or pytest.raises
- [ ] Nested data loading tested thoroughly
- [ ] Currently testing pointer logic tested
- [ ] Authorization tested for different roles
- [ ] Business constraints tested (max 5 theses)
- [ ] Admin-only fields tested

## LOC Estimate
~180 lines