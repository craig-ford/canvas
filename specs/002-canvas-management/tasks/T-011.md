# specs/002-canvas-management/tasks/T-011.md

## Task: Attachment API Integration Tests

## Type
integration-test

## Context
- **Phase**: API Layer
- **Builds on**: T-006 (AttachmentService Integration Tests)
- **Blocks**: T-018 (Attachment API Routes)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/db.py | T-007 | `from canvas.db import get_db_session` |
| 001-auth | backend/canvas/auth/dependencies.py | T-004 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001-auth | backend/canvas/models/user.py | T-001 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-006 | backend/canvas/services/attachment_service.py | AttachmentService |

## Scope
- **CREATE**: `backend/tests/canvas/test_attachment_api.py`

## Contract
```python
import pytest
import tempfile
from pathlib import Path
from uuid import uuid4
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User, UserRole
from canvas.models.vbu import VBU
from canvas.models.proof_point import ProofPoint
from canvas.models.attachment import Attachment

class TestAttachmentAPI:
    """Integration tests for file upload/download endpoints"""
    
    async def test_upload_file_success(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test POST /api/attachments uploads file with multipart form data"""
        ...
    
    async def test_upload_file_unauthorized(self, client: AsyncClient, sample_proof_point: ProofPoint):
        """Test POST without auth returns 401"""
        ...
    
    async def test_upload_file_forbidden_viewer(self, client: AsyncClient, viewer_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test POST by viewer returns 403"""
        ...
    
    async def test_upload_file_too_large(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test POST with file >10MB returns 413 FILE_TOO_LARGE"""
        ...
    
    async def test_upload_unsupported_type(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test POST with unsupported MIME type returns 415 UNSUPPORTED_TYPE"""
        ...
    
    async def test_upload_with_label(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test POST with optional label field"""
        ...
    
    async def test_download_file_success(self, client: AsyncClient, auth_headers: dict, sample_attachment: Attachment):
        """Test GET /api/attachments/{id} returns file with proper headers"""
        ...
    
    async def test_download_file_not_found(self, client: AsyncClient, auth_headers: dict):
        """Test GET with invalid ID returns 404"""
        ...
    
    async def test_download_file_forbidden_other_gm(self, client: AsyncClient, other_gm_auth_headers: dict, sample_attachment: Attachment):
        """Test GET by different GM returns 403"""
        ...
    
    async def test_delete_file_success(self, client: AsyncClient, gm_auth_headers: dict, sample_attachment: Attachment):
        """Test DELETE /api/attachments/{id} removes file and database record"""
        ...
    
    async def test_delete_file_forbidden_viewer(self, client: AsyncClient, viewer_auth_headers: dict, sample_attachment: Attachment):
        """Test DELETE by viewer returns 403"""
        ...
```

## Logic
1. Import required models and test utilities for multipart file uploads
2. Create test fixtures for sample attachments and different file types
3. Test POST /api/attachments with multipart/form-data including file and metadata
4. Test file validation: size limit (10MB), allowed MIME types (image/png, image/jpeg, image/gif, application/pdf, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/vnd.openxmlformats-officedocument.presentationml.presentation)
5. Test GET /api/attachments/{id} returns file with correct Content-Type and Content-Disposition headers
6. Test DELETE /api/attachments/{id} removes file from filesystem and database
7. Test authorization: GM can only access attachments from own VBU, viewer read-only
8. Test error cases: file not found, unsupported types, size limits
9. Verify response envelopes and error codes match API specification

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass

## LOC Estimate
~140 lines