# specs/002-canvas-management/tasks/T-011.md

## Task: Attachment Service Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-002 (AttachmentService contract), T-003 (SQLAlchemy models)
- **Blocks**: T-013 (AttachmentService implementation)
- **Requirements**: FR-003, FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | backend/canvas/services/attachment_service.py | AttachmentService interface |
| T-003 | backend/canvas/models/attachment.py | Attachment model |

## Scope
- **CREATE**: `backend/tests/unit/test_attachment_service.py`

## Contract
```python
import pytest
from unittest.mock import Mock, AsyncMock, patch
from pathlib import Path
from fastapi import UploadFile
from canvas.services.attachment_service import AttachmentService
from canvas.models.attachment import Attachment

class TestAttachmentService:
    @pytest.fixture
    def service(self):
        return AttachmentService(upload_dir="/tmp/test", max_size_mb=10)
    
    @pytest.fixture
    def mock_file(self):
        file = Mock(spec=UploadFile)
        file.filename = "test.pdf"
        file.content_type = "application/pdf"
        file.size = 1024
        file.read = AsyncMock(return_value=b"test content")
        return file

    async def test_upload_valid_file(self, service, mock_file):
        """Test successful file upload with valid parameters"""
        assert True  # Placeholder for actual test

    async def test_upload_file_too_large(self, service):
        """Test file upload rejection when size exceeds limit"""
        assert True  # Placeholder for actual test

    async def test_upload_invalid_content_type(self, service):
        """Test file upload rejection for unsupported MIME types"""
        assert True  # Placeholder for actual test

    async def test_download_existing_file(self, service):
        """Test file download with proper headers and authorization"""
        assert True  # Placeholder for actual test

    async def test_download_nonexistent_file(self, service):
        """Test download attempt for non-existent attachment"""
        assert True  # Placeholder for actual test

    async def test_delete_existing_file(self, service):
        """Test file deletion from both filesystem and database"""
        assert True  # Placeholder for actual test

    async def test_delete_nonexistent_file(self, service):
        """Test deletion attempt for non-existent attachment"""
        assert True  # Placeholder for actual test

    def test_validate_file_size_within_limit(self, service):
        """Test file size validation for files within limit"""
        assert service._validate_file_size(1024) is True

    def test_validate_file_size_exceeds_limit(self, service):
        """Test file size validation for oversized files"""
        with pytest.raises(ValueError, match="File size exceeds"):
            service._validate_file_size(11 * 1024 * 1024)

    def test_validate_content_type_allowed(self, service):
        """Test content type validation for allowed MIME types"""
        assert service._validate_content_type("application/pdf") is True

    def test_validate_content_type_disallowed(self, service):
        """Test content type validation for disallowed MIME types"""
        with pytest.raises(ValueError, match="Unsupported file type"):
            service._validate_content_type("application/exe")

    def test_generate_storage_path(self, service):
        """Test storage path generation with UUID and extension"""
        path = service._generate_storage_path("test.pdf", "vbu-123", "proof_point")
        assert "/uploads/vbu-123/proof_point/" in str(path)
        assert path.suffix == ".pdf"
```

## Logic
1. Import AttachmentService interface from T-002
2. Import Attachment model from T-003
3. Create test fixtures for service instance and mock files
4. Test file upload validation (size, type, content)
5. Test file download with authorization checks
6. Test file deletion with cleanup
7. Test private validation methods
8. Test storage path generation logic

## Verification
- [ ] All test methods contain assertions or pytest.raises
- [ ] Mock objects properly configured for async operations
- [ ] File validation edge cases covered
- [ ] Authorization scenarios tested
- [ ] Storage path generation validated

## LOC Estimate
~120 lines