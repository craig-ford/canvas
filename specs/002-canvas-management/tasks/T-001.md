# specs/002-canvas-management/tasks/T-001.md

## Task: Canvas Service Contract Tests

## Type
contract-test

## Context
- **Phase**: Contracts & Interfaces
- **Builds on**: None
- **Blocks**: T-008, T-012
- **Requirements**: FR-002, FR-003, FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/models/__init__.py | 001A-infrastructure/T-006 | `from canvas.models import TimestampMixin` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| None | None | None |

## Scope
- **CREATE**: `backend/canvas/services/canvas_service.py`
- **CREATE**: `tests/canvas/test_canvas_service_contract.py`

## Contract
```python
from abc import ABC, abstractmethod
from typing import Optional, List
from uuid import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.vbu import VBU
from canvas.models.canvas import Canvas
from canvas.models.thesis import Thesis
from canvas.models.proof_point import ProofPoint

class CanvasServiceInterface(ABC):
    @abstractmethod
    async def create_vbu(self, name: str, gm_id: UUID, created_by: UUID, db: AsyncSession) -> VBU:
        """Create VBU with auto-generated canvas."""
        ...
    
    @abstractmethod
    async def get_vbu_by_id(self, vbu_id: UUID, db: AsyncSession) -> Optional[VBU]:
        """Get VBU by ID with authorization check."""
        ...
    
    @abstractmethod
    async def list_vbus_for_user(self, user_id: UUID, user_role: str, db: AsyncSession) -> List[VBU]:
        """List VBUs filtered by user role and ownership."""
        ...
    
    @abstractmethod
    async def update_vbu(self, vbu_id: UUID, name: Optional[str], gm_id: Optional[UUID], updated_by: UUID, db: AsyncSession) -> VBU:
        """Update VBU with authorization check."""
        ...
    
    @abstractmethod
    async def delete_vbu(self, vbu_id: UUID, db: AsyncSession) -> None:
        """Delete VBU and cascade to canvas."""
        ...
    
    @abstractmethod
    async def get_canvas_by_vbu(self, vbu_id: UUID, db: AsyncSession) -> Optional[Canvas]:
        """Get canvas with nested theses and proof points."""
        ...
    
    @abstractmethod
    async def update_canvas(self, vbu_id: UUID, canvas_data: dict, updated_by: UUID, db: AsyncSession) -> Canvas:
        """Update canvas fields with authorization."""
        ...
    
    @abstractmethod
    async def create_thesis(self, canvas_id: UUID, text: str, order: int, db: AsyncSession) -> Thesis:
        """Create thesis with order validation."""
        ...
    
    @abstractmethod
    async def update_thesis(self, thesis_id: UUID, text: str, db: AsyncSession) -> Thesis:
        """Update thesis text."""
        ...
    
    @abstractmethod
    async def delete_thesis(self, thesis_id: UUID, db: AsyncSession) -> None:
        """Delete thesis and cascade to proof points."""
        ...
    
    @abstractmethod
    async def reorder_theses(self, canvas_id: UUID, thesis_orders: List[dict], db: AsyncSession) -> List[Thesis]:
        """Reorder theses with constraint validation."""
        ...
    
    @abstractmethod
    async def create_proof_point(self, thesis_id: UUID, description: str, status: str, db: AsyncSession) -> ProofPoint:
        """Create proof point with status validation."""
        ...
    
    @abstractmethod
    async def update_proof_point(self, proof_point_id: UUID, data: dict, db: AsyncSession) -> ProofPoint:
        """Update proof point fields."""
        ...
    
    @abstractmethod
    async def delete_proof_point(self, proof_point_id: UUID, db: AsyncSession) -> None:
        """Delete proof point and cascade to attachments."""
        ...

class CanvasService(CanvasServiceInterface):
    """Canvas management service implementation."""
    
    async def create_vbu(self, name: str, gm_id: UUID, created_by: UUID, db: AsyncSession) -> VBU:
        ...
    
    async def get_vbu_by_id(self, vbu_id: UUID, db: AsyncSession) -> Optional[VBU]:
        ...
    
    async def list_vbus_for_user(self, user_id: UUID, user_role: str, db: AsyncSession) -> List[VBU]:
        ...
    
    async def update_vbu(self, vbu_id: UUID, name: Optional[str], gm_id: Optional[UUID], updated_by: UUID, db: AsyncSession) -> VBU:
        ...
    
    async def delete_vbu(self, vbu_id: UUID, db: AsyncSession) -> None:
        ...
    
    async def get_canvas_by_vbu(self, vbu_id: UUID, db: AsyncSession) -> Optional[Canvas]:
        ...
    
    async def update_canvas(self, vbu_id: UUID, canvas_data: dict, updated_by: UUID, db: AsyncSession) -> Canvas:
        ...
    
    async def create_thesis(self, canvas_id: UUID, text: str, order: int, db: AsyncSession) -> Thesis:
        ...
    
    async def update_thesis(self, thesis_id: UUID, text: str, db: AsyncSession) -> Thesis:
        ...
    
    async def delete_thesis(self, thesis_id: UUID, db: AsyncSession) -> None:
        ...
    
    async def reorder_theses(self, canvas_id: UUID, thesis_orders: List[dict], db: AsyncSession) -> List[Thesis]:
        ...
    
    async def create_proof_point(self, thesis_id: UUID, description: str, status: str, db: AsyncSession) -> ProofPoint:
        ...
    
    async def update_proof_point(self, proof_point_id: UUID, data: dict, db: AsyncSession) -> ProofPoint:
        ...
    
    async def delete_proof_point(self, proof_point_id: UUID, db: AsyncSession) -> None:
        ...
```

## Logic
1. Define CanvasServiceInterface with all CRUD methods
2. Create CanvasService class implementing interface
3. Write contract tests verifying interface compliance
4. Test method signatures and return types
5. Verify abstract methods raise NotImplementedError

## Verification
- [ ] Interface defines all required methods
- [ ] Service class implements interface
- [ ] Contract tests verify method signatures
- [ ] All test methods contain assertions

## LOC Estimate
~150 lines