# specs/002-canvas-management/tasks/T-014.md

## Task: VBU API Routes

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-007 (VBU service unit tests), T-012 (CanvasService implementation)
- **Blocks**: Frontend VBU management interface
- **Requirements**: FR-001

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/__init__.py | 001A-infrastructure/T-006 | `from canvas import success_response, list_response` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-007 | backend/tests/unit/test_vbu_service.py | VBU service test contracts |
| T-012 | backend/canvas/services/canvas_service.py | CanvasService for VBU operations |

## Scope
- **CREATE**: `backend/canvas/routes/vbu.py`

## Contract
```python
from typing import List, Optional
from uuid import UUID
from fastapi import APIRouter, Depends, HTTPException, Query, status
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.dependencies import get_current_user, require_role
from canvas.services.canvas_service import CanvasService
from canvas.models.user import User
from canvas.db import get_db
from canvas import success_response, list_response

router = APIRouter(prefix="/api/vbus", tags=["vbu"])

@router.get("")
async def list_vbus(
    page: int = Query(1, ge=1),
    per_page: int = Query(25, ge=1, le=100),
    gm_id: Optional[UUID] = Query(None),
    name: Optional[str] = Query(None),
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """List VBUs with role-based filtering"""
    ...

@router.post("", status_code=status.HTTP_201_CREATED)
async def create_vbu(
    vbu_data: dict,
    current_user: User = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Create new VBU (admin only)"""
    ...

@router.get("/{vbu_id}")
async def get_vbu(
    vbu_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Get VBU detail with authorization check"""
    ...

@router.patch("/{vbu_id}")
async def update_vbu(
    vbu_id: UUID,
    vbu_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Update VBU (admin or owning GM)"""
    ...

@router.delete("/{vbu_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_vbu(
    vbu_id: UUID,
    current_user: User = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
):
    """Delete VBU (admin only)"""
    ...
```

## Logic
1. Import auth dependencies from Herald-specified paths
2. Import response helpers from canvas.__init__
3. Import CanvasService for VBU operations
4. Implement list_vbus with role-based filtering:
   - Admin sees all VBUs
   - GM sees only their own VBUs
   - Viewer sees all VBUs (read-only)
5. Implement create_vbu (admin only) with validation
6. Implement get_vbu with ownership authorization
7. Implement update_vbu with admin/GM authorization
8. Implement delete_vbu (admin only) with cascade handling

## Verification
- [ ] All routes use proper auth dependencies
- [ ] Role-based filtering implemented correctly
- [ ] Response envelopes use success_response/list_response
- [ ] Error handling returns appropriate HTTP status codes
- [ ] Authorization checks enforce ownership rules

## LOC Estimate
~60 lines