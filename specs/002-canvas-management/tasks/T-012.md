# specs/002-canvas-management/tasks/T-012.md

## Task: CanvasService Implementation

## Type
implementation

## Context
- **Phase**: Phase 4 - Core Logic
- **Builds on**: T-008 (Canvas Service Unit Tests)
- **Blocks**: T-015 (Canvas API Endpoints)
- **Requirements**: FR-002, FR-006, FR-007

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-008 | backend/tests/test_canvas_service.py | Test contracts to implement |
| T-003 | backend/canvas/models/ | Canvas, VBU, Thesis, ProofPoint models |

## Scope
- **MODIFY**: `backend/canvas/services/canvas_service.py`

## Contract
```python
from typing import Optional, List
from uuid import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from sqlalchemy.orm import selectinload
from canvas.models.canvas import Canvas
from canvas.models.vbu import VBU
from canvas.models.thesis import Thesis
from canvas.models.proof_point import ProofPoint

class CanvasService:
    """Core canvas management logic with authorization."""
    
    async def get_canvas_by_vbu(self, vbu_id: UUID, current_user, db: AsyncSession) -> Canvas:
        """Get canvas with all nested data (theses, proof points, attachments)."""
        # Query VBU with authorization check
        # Load canvas with nested relationships
        # Return canvas or raise NotFoundError/ForbiddenError
        ...
    
    async def update_canvas(self, vbu_id: UUID, canvas_data: dict, current_user, db: AsyncSession) -> Canvas:
        """Update canvas fields with authorization and audit logging."""
        # Get canvas with authorization
        # Filter portfolio_notes for non-admin users
        # Update allowed fields only
        # Set updated_by and updated_at
        # Commit and return updated canvas
        ...
    
    async def update_currently_testing(self, canvas_id: UUID, testing_type: Optional[str], testing_id: Optional[UUID], current_user, db: AsyncSession) -> Canvas:
        """Update currently testing pointer with referential integrity check."""
        # Get canvas with authorization
        # Validate testing_type and testing_id combination
        # Check referential integrity (thesis/proof_point exists)
        # Update pointer fields
        # Commit and return canvas
        ...
    
    async def create_thesis(self, canvas_id: UUID, thesis_data: dict, current_user, db: AsyncSession) -> Thesis:
        """Create thesis with order validation (max 5)."""
        # Get canvas with authorization
        # Check thesis count < 5
        # Determine next order number
        # Create thesis
        # Commit and return thesis
        ...
    
    async def update_thesis(self, thesis_id: UUID, thesis_data: dict, current_user, db: AsyncSession) -> Thesis:
        """Update thesis with authorization."""
        # Get thesis with canvas authorization check
        # Update text field
        # Commit and return thesis
        ...
    
    async def delete_thesis(self, thesis_id: UUID, current_user, db: AsyncSession) -> None:
        """Delete thesis with cascade to proof points."""
        # Get thesis with authorization
        # Delete (cascades automatically)
        # Reorder remaining theses
        # Commit
        ...
    
    async def create_proof_point(self, thesis_id: UUID, proof_point_data: dict, current_user, db: AsyncSession) -> ProofPoint:
        """Create proof point with validation."""
        # Get thesis with authorization
        # Create proof point
        # Commit and return proof point
        ...
    
    async def update_proof_point(self, proof_point_id: UUID, proof_point_data: dict, current_user, db: AsyncSession) -> ProofPoint:
        """Update proof point with validation."""
        # Get proof point with authorization
        # Update fields
        # Commit and return proof point
        ...
    
    async def delete_proof_point(self, proof_point_id: UUID, current_user, db: AsyncSession) -> None:
        """Delete proof point with cascade to attachments."""
        # Get proof point with authorization
        # Delete (cascades automatically)
        # Commit
        ...
    
    def _check_canvas_authorization(self, canvas: Canvas, current_user) -> None:
        """Check if user can access canvas."""
        # Admin: full access
        # GM: own VBU only
        # Viewer: read-only access
        # Raise ForbiddenError if unauthorized
        ...
    
    def _filter_admin_fields(self, data: dict, current_user) -> dict:
        """Remove admin-only fields for non-admin users."""
        # Remove portfolio_notes if not admin
        # Return filtered data
        ...
```

## Logic
1. Import required models and dependencies
2. Implement get_canvas_by_vbu with nested loading
3. Implement update_canvas with field filtering
4. Implement currently_testing pointer management
5. Implement thesis CRUD operations
6. Implement proof point CRUD operations
7. Implement authorization helper methods
8. Add proper error handling and validation
9. Ensure all database operations are properly committed

## Verification
- [ ] All methods have real implementation (no pass statements)
- [ ] Authorization checks implemented for all operations
- [ ] Database queries use proper async/await
- [ ] Error handling for NotFound and Forbidden cases
- [ ] Admin-only field filtering implemented
- [ ] Referential integrity checks for currently_testing

## LOC Estimate
~200 lines