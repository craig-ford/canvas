# specs/002-canvas-management/tasks/T-018.md

## Task: Attachment API Routes

## Type
implementation

## Context
- **Phase**: API Layer
- **Builds on**: T-011 (Attachment API Integration Tests), T-013 (AttachmentService Implementation)
- **Blocks**: T-023 (Canvas API Client)
- **Requirements**: FR-005, FR-008

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/db.py | T-007 | `from canvas.db import get_db_session` |
| 001A-infrastructure | backend/canvas/__init__.py | T-006 | `from canvas import success_response` |
| 001-auth | backend/canvas/auth/dependencies.py | T-004 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001-auth | backend/canvas/models/user.py | T-001 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-013 | backend/canvas/services/attachment_service.py | AttachmentService |

## Scope
- **CREATE**: `backend/canvas/routes/attachment.py`

## Contract
```python
from uuid import UUID
from typing import Optional
from fastapi import APIRouter, Depends, File, Form, HTTPException, UploadFile, status
from fastapi.responses import FileResponse
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.db import get_db_session
from canvas.auth.dependencies import get_current_user, require_role
from canvas.models.user import User
from canvas.services.attachment_service import AttachmentService
from canvas import success_response

router = APIRouter(prefix="/api/attachments", tags=["attachments"])

@router.post("", status_code=201)
async def upload_attachment(
    file: UploadFile = File(...),
    proof_point_id: Optional[UUID] = Form(None),
    monthly_review_id: Optional[UUID] = Form(None),
    label: Optional[str] = Form(None),
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session),
    attachment_service: AttachmentService = Depends()
) -> dict:
    """Upload file attachment to proof point or monthly review"""
    ...

@router.get("/{attachment_id}")
async def download_attachment(
    attachment_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db_session),
    attachment_service: AttachmentService = Depends()
) -> FileResponse:
    """Download attachment file with proper MIME headers"""
    ...

@router.delete("/{attachment_id}", status_code=204)
async def delete_attachment(
    attachment_id: UUID,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session),
    attachment_service: AttachmentService = Depends()
) -> None:
    """Delete attachment file and database record"""
    ...
```

## Logic
1. Import FastAPI components, dependencies, and AttachmentService
2. Create router with /api/attachments prefix
3. Implement POST endpoint:
   - Accept multipart/form-data with file and metadata
   - Validate exactly one of proof_point_id or monthly_review_id provided
   - Call AttachmentService.upload with validated parameters
   - Return attachment data with success_response envelope
4. Implement GET endpoint:
   - Call AttachmentService.download with attachment_id
   - Return FileResponse with proper Content-Type and Content-Disposition headers
5. Implement DELETE endpoint:
   - Call AttachmentService.delete with attachment_id
   - Return 204 No Content on success
6. Handle HTTPExceptions from service layer (file validation, authorization)
7. Use require_role dependency for upload/delete (admin/gm only)
8. Use get_current_user for download (all authenticated users)

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass

## LOC Estimate
~45 lines