# specs/002-canvas-management/tasks/T-018.md

## Task: Attachment API Endpoints

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-011 (Attachment Service Unit Tests), T-013 (AttachmentService Implementation)
- **Blocks**: T-019 (CLI commands)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-013 | backend/canvas/services/attachment_service.py | AttachmentService class |

## Scope
- **CREATE**: `backend/canvas/routes/attachment.py`

## Contract
```python
from fastapi import APIRouter, Depends, HTTPException, status, UploadFile, File, Form
from fastapi.responses import FileResponse
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional
from uuid import UUID

from canvas.auth.dependencies import get_current_user, require_role
from canvas.db import get_db_session
from canvas.services.attachment_service import AttachmentService
from canvas.schemas import AttachmentResponse
from canvas.models.user import User
from canvas import success_response

router = APIRouter(prefix="/api", tags=["attachment"])

@router.post("/attachments")
async def upload_attachment(
    file: UploadFile = File(...),
    proof_point_id: Optional[UUID] = Form(None),
    monthly_review_id: Optional[UUID] = Form(None),
    label: Optional[str] = Form(None),
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Upload file attachment to proof point or monthly review."""
    ...

@router.get("/attachments/{attachment_id}")
async def download_attachment(
    attachment_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db_session)
) -> FileResponse:
    """Download file attachment with proper headers."""
    ...

@router.delete("/attachments/{attachment_id}")
async def delete_attachment(
    attachment_id: UUID,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Delete attachment from filesystem and database."""
    ...
```

## Logic
1. Import AttachmentService from T-013
2. Import auth dependencies from 001-auth
3. Import response helpers from canvas.__init__
4. Define router with /api prefix
5. Implement upload_attachment - validate parent entity ownership, validate file, upload via service, return response
6. Implement download_attachment - validate access to parent entity, return FileResponse via service
7. Implement delete_attachment - validate ownership, delete via service, return success
8. Handle multipart form data for file uploads
9. Enforce 10MB file size limit and allowed MIME types

## Verification
- [ ] File upload handles multipart/form-data correctly
- [ ] File size validation (10MB max) enforced
- [ ] MIME type validation against allowed list
- [ ] GM users can only upload/download files from their own VBUs
- [ ] Admin users can access all attachments
- [ ] File cleanup on delete works properly
- [ ] Proper HTTP headers for file downloads

## LOC Estimate
~90 lines