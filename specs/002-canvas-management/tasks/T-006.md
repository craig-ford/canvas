# specs/002-canvas-management/tasks/T-006.md

## Task: AttachmentService Integration Tests

## Type
integration-test

## Context
- **Phase**: Data Layer
- **Builds on**: T-002 (Service Contract Tests), T-004 (Database Migration)
- **Blocks**: T-010 (ProofPoint API Integration Tests), T-011 (Attachment API Integration Tests)
- **Requirements**: FR-004, FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/db.py | T-007 | `from canvas.db import get_db_session` |
| 001-auth | backend/canvas/models/user.py | T-001 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | backend/tests/canvas/test_services_contract.py | AttachmentService interface |
| T-004 | backend/canvas/models/attachment.py | Attachment model |

## Scope
- **CREATE**: `backend/tests/canvas/test_attachment_service_integration.py`

## Contract
```python
import pytest
import tempfile
from pathlib import Path
from uuid import uuid4
from fastapi import UploadFile
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.services.attachment_service import AttachmentService
from canvas.models.attachment import Attachment
from canvas.models.user import User

class TestAttachmentServiceIntegration:
    """Integration tests for AttachmentService with real filesystem"""
    
    async def test_upload_valid_file(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test successful file upload with validation"""
        ...
    
    async def test_upload_file_too_large(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test file size validation (max 10MB)"""
        ...
    
    async def test_upload_invalid_content_type(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test content type validation"""
        ...
    
    async def test_download_existing_file(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test file download with proper headers"""
        ...
    
    async def test_download_nonexistent_file(self, db_session: AsyncSession, temp_upload_dir: Path):
        """Test download of non-existent attachment"""
        ...
    
    async def test_delete_existing_file(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test file deletion from filesystem and database"""
        ...
    
    async def test_storage_path_generation(self, db_session: AsyncSession, sample_user: User, temp_upload_dir: Path):
        """Test storage path follows pattern: /uploads/{vbu_id}/{entity_type}/{uuid}.{ext}"""
        ...
```

## Logic
1. Import AttachmentService from T-002 contract and Attachment model from T-004
2. Create test fixtures for temporary upload directory and sample data
3. Test upload method with valid PNG file, verify file saved and database record created
4. Test upload validation: file size limit (10MB), allowed content types
5. Test download method returns FileResponse with correct headers and content
6. Test delete method removes file from filesystem and database record
7. Test storage path generation follows specified pattern
8. Use real filesystem operations with temporary directories for isolation

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass

## LOC Estimate
~120 lines