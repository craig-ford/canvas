# specs/002-canvas-management/tasks/T-006.md

## Task: Authorization Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-003 (SQLAlchemy models)
- **Blocks**: T-012, T-013 (Service implementations)
- **Requirements**: FR-008

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001-auth | backend/canvas/models/user.py | 001-auth/T-011 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/models/*.py | All model classes: VBU, Canvas, Thesis, ProofPoint, Attachment |

## Scope
- **CREATE**: `backend/tests/test_canvas_authorization.py`

## Contract
```python
import pytest
from fastapi import HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User
from canvas.models.vbu import VBU
from canvas.models.canvas import Canvas

@pytest.fixture
async def admin_user(db_session: AsyncSession) -> User:
    """Create admin user for testing"""
    user = User(email="admin@test.com", role="admin", name="Admin User")
    db_session.add(user)
    await db_session.commit()
    return user

@pytest.fixture
async def gm_user(db_session: AsyncSession) -> User:
    """Create GM user for testing"""
    user = User(email="gm@test.com", role="gm", name="GM User")
    db_session.add(user)
    await db_session.commit()
    return user

@pytest.fixture
async def viewer_user(db_session: AsyncSession) -> User:
    """Create viewer user for testing"""
    user = User(email="viewer@test.com", role="viewer", name="Viewer User")
    db_session.add(user)
    await db_session.commit()
    return user

@pytest.fixture
async def other_gm_user(db_session: AsyncSession) -> User:
    """Create second GM user for testing"""
    user = User(email="other@test.com", role="gm", name="Other GM")
    db_session.add(user)
    await db_session.commit()
    return user

@pytest.mark.asyncio
async def test_admin_can_access_all_vbus(db_session: AsyncSession, admin_user: User, gm_user: User):
    """Test admin can access all VBUs regardless of ownership"""
    # Create VBU owned by GM
    # Verify admin can read/write
    assert vbu.gm_id == gm_user.id

@pytest.mark.asyncio
async def test_gm_can_only_access_own_vbus(db_session: AsyncSession, gm_user: User, other_gm_user: User):
    """Test GM can only access their own VBUs"""
    # Create VBU owned by gm_user
    # Create VBU owned by other_gm_user
    # Verify gm_user can access own but not other's
    assert len(accessible_vbus) == 1

@pytest.mark.asyncio
async def test_viewer_has_read_only_access(db_session: AsyncSession, viewer_user: User, gm_user: User):
    """Test viewer can read all VBUs but cannot modify"""
    # Create VBU
    # Verify viewer can read
    # Verify viewer cannot modify (should raise HTTPException)
    with pytest.raises(HTTPException) as exc_info:
        # Attempt to modify as viewer
        pass
    assert exc_info.value.status_code == 403

@pytest.mark.asyncio
async def test_portfolio_notes_admin_only(db_session: AsyncSession, admin_user: User, gm_user: User):
    """Test portfolio_notes field is admin-only"""
    # Create canvas
    # Verify admin can read/write portfolio_notes
    # Verify GM cannot see portfolio_notes in response
    assert canvas_response.portfolio_notes is None

@pytest.mark.asyncio
async def test_file_upload_authorization(db_session: AsyncSession, gm_user: User, other_gm_user: User):
    """Test file upload restricted to VBU owner"""
    # Create VBU owned by gm_user
    # Verify gm_user can upload files
    # Verify other_gm_user cannot upload files
    with pytest.raises(HTTPException) as exc_info:
        # Attempt upload by non-owner
        pass
    assert exc_info.value.status_code == 403

@pytest.mark.asyncio
async def test_cross_vbu_data_isolation(db_session: AsyncSession, gm_user: User, other_gm_user: User):
    """Test GMs cannot access each other's data"""
    # Create VBUs for both GMs with canvases
    # Verify each GM can only see their own data
    # Verify no data leakage in queries
    assert len(gm_vbus) == 1
    assert len(other_gm_vbus) == 1

@pytest.mark.asyncio
async def test_authorization_with_nested_resources(db_session: AsyncSession, gm_user: User, other_gm_user: User):
    """Test authorization works for nested resources (thesis, proof points)"""
    # Create VBU with canvas, thesis, proof points
    # Verify owner can access nested resources
    # Verify non-owner cannot access nested resources
    with pytest.raises(HTTPException):
        # Access nested resource as non-owner
        pass
```

## Logic
1. Create user fixtures for all roles (admin, gm, viewer)
2. Test admin has full access to all VBUs
3. Test GM can only access own VBUs
4. Test viewer has read-only access
5. Test portfolio_notes field is admin-only
6. Test file upload authorization
7. Test data isolation between GMs
8. Test authorization for nested resources

## Verification
- [ ] All authorization rules enforced correctly
- [ ] Proper HTTP exceptions raised for violations
- [ ] Data isolation between users maintained
- [ ] Admin-only fields properly restricted

## LOC Estimate
~180 lines