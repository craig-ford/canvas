# specs/002-canvas-management/tasks/T-007.md

## Task: VBU Service Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: None
- **Blocks**: T-014 (VBU API Endpoints)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/services/canvas_service.py | CanvasService interface |
| T-003 | backend/canvas/models/ | VBU, Canvas, User models |

## Scope
- **CREATE**: `backend/tests/test_vbu_service.py`

## Contract
```python
class TestVBUService:
    """Test VBU CRUD operations with authorization and validation."""
    
    async def test_create_vbu_as_admin(self, db_session, admin_user, gm_user):
        """Admin can create VBU with valid GM ID."""
        assert result.name == "Test VBU"
        assert result.gm_id == gm_user.id
    
    async def test_create_vbu_invalid_gm_id(self, db_session, admin_user):
        """Creating VBU with invalid GM ID raises ValidationError."""
        with pytest.raises(ValidationError):
            ...
    
    async def test_list_vbus_as_admin(self, db_session, admin_user, sample_vbus):
        """Admin sees all VBUs."""
        assert len(result) == 3
    
    async def test_list_vbus_as_gm(self, db_session, gm_user, sample_vbus):
        """GM sees only their own VBUs."""
        assert len(result) == 1
        assert result[0].gm_id == gm_user.id
    
    async def test_list_vbus_as_viewer(self, db_session, viewer_user, sample_vbus):
        """Viewer sees all VBUs read-only."""
        assert len(result) == 3
    
    async def test_get_vbu_as_owner(self, db_session, gm_user, sample_vbu):
        """GM can get their own VBU."""
        assert result.id == sample_vbu.id
    
    async def test_get_vbu_as_non_owner(self, db_session, gm_user, other_vbu):
        """GM cannot get other GM's VBU."""
        with pytest.raises(ForbiddenError):
            ...
    
    async def test_update_vbu_as_admin(self, db_session, admin_user, sample_vbu):
        """Admin can update any VBU."""
        assert result.name == "Updated Name"
    
    async def test_update_vbu_as_owner(self, db_session, gm_user, sample_vbu):
        """GM can update their own VBU name only."""
        assert result.name == "Updated Name"
        assert result.gm_id == gm_user.id  # Cannot change GM
    
    async def test_delete_vbu_as_admin(self, db_session, admin_user, sample_vbu):
        """Admin can delete VBU (cascades to canvas)."""
        # Verify VBU and canvas are deleted
        assert deleted_vbu is None
        assert deleted_canvas is None
    
    async def test_delete_vbu_as_gm_forbidden(self, db_session, gm_user, sample_vbu):
        """GM cannot delete VBU."""
        with pytest.raises(ForbiddenError):
            ...
```

## Logic
1. Import CanvasService, models, auth dependencies
2. Define test fixtures for users and sample VBUs
3. Test VBU creation with validation and authorization
4. Test VBU listing with role-based filtering
5. Test VBU retrieval with ownership checks
6. Test VBU updates with field restrictions
7. Test VBU deletion with cascade behavior
8. Test authorization failures return proper errors

## Verification
- [ ] All test methods contain assertions or pytest.raises
- [ ] Authorization tested for all roles (admin, gm, viewer)
- [ ] Validation errors tested for invalid inputs
- [ ] Cascade deletion tested
- [ ] Database session cleanup in fixtures

## LOC Estimate
~150 lines