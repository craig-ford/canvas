# specs/002-canvas-management/tasks/T-010.md

## Task: ProofPoint Service Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: None
- **Blocks**: T-017 (ProofPoint API Endpoints)
- **Requirements**: FR-002

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/auth/dependencies.py | 001-auth/T-015 | `from auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/services/canvas_service.py | CanvasService interface |
| T-003 | backend/canvas/models/ | ProofPoint, Thesis, Attachment models |

## Scope
- **CREATE**: `backend/tests/test_proof_point_service.py`

## Contract
```python
class TestProofPointService:
    """Test proof point operations, status tracking, evidence notes."""
    
    async def test_create_proof_point_basic(self, db_session, gm_user, sample_thesis):
        """Create proof point with required fields."""
        assert result.description == "Test proof point"
        assert result.status == ProofPointStatus.NOT_STARTED
        assert result.thesis_id == sample_thesis.id
    
    async def test_create_proof_point_with_optional_fields(self, db_session, gm_user, sample_thesis):
        """Create proof point with evidence note and target date."""
        assert result.evidence_note == "Initial evidence"
        assert result.target_review_month.year == 2026
        assert result.target_review_month.month == 3
    
    async def test_create_proof_point_unauthorized(self, db_session, other_gm_user, sample_thesis):
        """GM cannot create proof point in other GM's thesis."""
        with pytest.raises(ForbiddenError):
            ...
    
    async def test_list_proof_points_with_attachments(self, db_session, thesis_with_proof_points):
        """List proof points includes nested attachments."""
        assert len(result) == 2
        assert len(result[0].attachments) == 1
        assert result[0].attachments[0].filename == "test.pdf"
    
    async def test_update_proof_point_status(self, db_session, gm_user, sample_proof_point):
        """Update proof point status with evidence note."""
        assert result.status == ProofPointStatus.IN_PROGRESS
        assert result.evidence_note == "Updated evidence"
    
    async def test_update_proof_point_target_date(self, db_session, gm_user, sample_proof_point):
        """Update target review month."""
        assert result.target_review_month.month == 6
    
    async def test_update_proof_point_unauthorized(self, db_session, other_gm_user, sample_proof_point):
        """GM cannot update other GM's proof point."""
        with pytest.raises(ForbiddenError):
            ...
    
    async def test_delete_proof_point_cascade_attachments(self, db_session, gm_user, proof_point_with_attachments):
        """Deleting proof point cascades to attachments."""
        # Verify proof point and attachments are deleted
        assert deleted_proof_point is None
        assert len(remaining_attachments) == 0
    
    async def test_proof_point_status_validation(self, db_session, gm_user, sample_proof_point):
        """Invalid status values raise ValidationError."""
        with pytest.raises(ValidationError, match="Invalid status"):
            ...
    
    async def test_proof_point_description_validation(self, db_session, gm_user, sample_thesis):
        """Empty description raises ValidationError."""
        with pytest.raises(ValidationError, match="Description cannot be empty"):
            ...
    
    async def test_proof_point_target_date_past_validation(self, db_session, gm_user, sample_thesis):
        """Target date too far in past raises ValidationError."""
        with pytest.raises(ValidationError, match="Target date too old"):
            ...
    
    async def test_proof_point_currently_testing_reference(self, db_session, sample_canvas, sample_proof_point):
        """Proof point can be referenced as currently testing."""
        # Update canvas currently_testing to this proof point
        assert canvas.currently_testing_type == CurrentlyTestingType.PROOF_POINT
        assert canvas.currently_testing_id == sample_proof_point.id
    
    async def test_proof_point_status_aggregation(self, db_session, canvas_with_mixed_proof_points):
        """Proof point statuses support dashboard aggregation."""
        # Count proof points by status
        assert status_counts[ProofPointStatus.NOT_STARTED] == 2
        assert status_counts[ProofPointStatus.IN_PROGRESS] == 1
        assert status_counts[ProofPointStatus.OBSERVED] == 1
```

## Logic
1. Import CanvasService, models, auth dependencies
2. Define test fixtures for proof points and related entities
3. Test proof point creation with required/optional fields
4. Test proof point listing with nested attachments
5. Test proof point updates (status, evidence, target date)
6. Test proof point deletion with cascade behavior
7. Test status validation and enum constraints
8. Test description and date validation
9. Test currently testing pointer integration
10. Test status aggregation for dashboard

## Verification
- [ ] All test methods contain assertions or pytest.raises
- [ ] Status enum validation tested
- [ ] Evidence note and target date handling tested
- [ ] Cascade deletion tested for attachments
- [ ] Authorization tested for all operations
- [ ] Currently testing pointer integration tested
- [ ] Dashboard aggregation support tested

## LOC Estimate
~170 lines