# specs/002-canvas-management/tasks/T-010.md

## Task: ProofPoint API Integration Tests

## Type
integration-test

## Context
- **Phase**: API Layer
- **Builds on**: T-006 (AttachmentService Integration Tests)
- **Blocks**: T-017 (ProofPoint API Routes)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/db.py | T-007 | `from canvas.db import get_db_session` |
| 001-auth | backend/canvas/auth/dependencies.py | T-004 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001-auth | backend/canvas/models/user.py | T-001 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-006 | backend/canvas/services/attachment_service.py | AttachmentService |

## Scope
- **CREATE**: `backend/tests/canvas/test_proof_point_api.py`

## Contract
```python
import pytest
from uuid import uuid4
from datetime import date
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User, UserRole
from canvas.models.vbu import VBU
from canvas.models.canvas import Canvas
from canvas.models.thesis import Thesis
from canvas.models.proof_point import ProofPoint, ProofPointStatus

class TestProofPointAPI:
    """Integration tests for proof point CRUD endpoints"""
    
    async def test_get_proof_points_success(self, client: AsyncClient, auth_headers: dict, sample_thesis: Thesis):
        """Test GET /api/theses/{thesis_id}/proof-points returns proof points with attachments"""
        ...
    
    async def test_get_proof_points_unauthorized(self, client: AsyncClient, sample_thesis: Thesis):
        """Test GET without auth returns 401"""
        ...
    
    async def test_create_proof_point_success(self, client: AsyncClient, gm_auth_headers: dict, sample_thesis: Thesis):
        """Test POST /api/theses/{thesis_id}/proof-points creates proof point"""
        ...
    
    async def test_create_proof_point_forbidden_viewer(self, client: AsyncClient, viewer_auth_headers: dict, sample_thesis: Thesis):
        """Test POST by viewer returns 403"""
        ...
    
    async def test_create_proof_point_validation_error(self, client: AsyncClient, gm_auth_headers: dict, sample_thesis: Thesis):
        """Test POST with invalid data returns 422"""
        ...
    
    async def test_update_proof_point_success(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test PATCH /api/proof-points/{id} updates proof point"""
        ...
    
    async def test_update_proof_point_status_change(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test PATCH updates status from not_started to in_progress"""
        ...
    
    async def test_update_proof_point_forbidden_other_gm(self, client: AsyncClient, other_gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test PATCH by different GM returns 403"""
        ...
    
    async def test_delete_proof_point_success(self, client: AsyncClient, gm_auth_headers: dict, sample_proof_point: ProofPoint):
        """Test DELETE /api/proof-points/{id} removes proof point"""
        ...
    
    async def test_delete_proof_point_not_found(self, client: AsyncClient, gm_auth_headers: dict):
        """Test DELETE with invalid ID returns 404"""
        ...
```

## Logic
1. Import required models and test utilities from auth and canvas features
2. Create test fixtures for sample thesis, proof point, and different user roles
3. Test GET /api/theses/{thesis_id}/proof-points returns list with attachments
4. Test POST /api/theses/{thesis_id}/proof-points creates proof point with validation
5. Test PATCH /api/proof-points/{id} updates fields including status changes
6. Test DELETE /api/proof-points/{id} removes proof point and cascades to attachments
7. Test authorization: GM can only access own VBU's proof points, viewer read-only
8. Test validation errors for required fields and invalid status values
9. Verify response envelopes match API specification

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass

## LOC Estimate
~150 lines