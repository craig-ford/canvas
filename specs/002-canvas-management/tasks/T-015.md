# specs/002-canvas-management/tasks/T-015.md

## Task: Canvas API Routes

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-008 (Canvas service unit tests), T-012 (CanvasService implementation)
- **Blocks**: Frontend canvas management interface
- **Requirements**: FR-002, FR-006, FR-007

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/__init__.py | 001A-infrastructure/T-006 | `from canvas import success_response, list_response` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-008 | backend/tests/unit/test_canvas_service.py | Canvas service test contracts |
| T-012 | backend/canvas/services/canvas_service.py | CanvasService for canvas operations |

## Scope
- **CREATE**: `backend/canvas/routes/canvas.py`

## Contract
```python
from uuid import UUID
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.dependencies import get_current_user, require_role
from canvas.services.canvas_service import CanvasService
from canvas.models.user import User
from canvas.db import get_db
from canvas import success_response, list_response

router = APIRouter(prefix="/api", tags=["canvas"])

@router.get("/vbus/{vbu_id}/canvas")
async def get_canvas(
    vbu_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Get canvas with nested theses and proof points"""
    ...

@router.put("/vbus/{vbu_id}/canvas")
async def update_canvas(
    vbu_id: UUID,
    canvas_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Create or update canvas with authorization"""
    ...

@router.post("/canvases/{canvas_id}/theses", status_code=status.HTTP_201_CREATED)
async def create_thesis(
    canvas_id: UUID,
    thesis_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Create thesis with order validation"""
    ...

@router.patch("/theses/{thesis_id}")
async def update_thesis(
    thesis_id: UUID,
    thesis_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Update thesis text"""
    ...

@router.delete("/theses/{thesis_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_thesis(
    thesis_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Delete thesis with cascade"""
    ...

@router.post("/theses/{thesis_id}/proof-points", status_code=status.HTTP_201_CREATED)
async def create_proof_point(
    thesis_id: UUID,
    proof_point_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Create proof point"""
    ...

@router.patch("/proof-points/{proof_point_id}")
async def update_proof_point(
    proof_point_id: UUID,
    proof_point_data: dict,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Update proof point status and evidence"""
    ...

@router.delete("/proof-points/{proof_point_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_proof_point(
    proof_point_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
):
    """Delete proof point"""
    ...
```

## Logic
1. Import auth dependencies from Herald-specified paths
2. Import response helpers from canvas.__init__
3. Import CanvasService for canvas operations
4. Implement get_canvas with nested data loading
5. Implement update_canvas with admin/GM authorization
6. Implement thesis CRUD operations with order validation
7. Implement proof point CRUD operations with status tracking
8. Apply authorization checks for VBU ownership

## Verification
- [ ] All routes use proper auth dependencies
- [ ] Canvas operations load nested data efficiently
- [ ] Thesis operations enforce 5-thesis limit
- [ ] Proof point operations handle status transitions
- [ ] Authorization enforces VBU ownership rules

## LOC Estimate
~90 lines