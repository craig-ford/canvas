# specs/002-canvas-management/tasks/T-004.md

## Task: Database Migration + Pydantic Schemas

## Type
implementation

## Context
- **Phase**: Data Layer
- **Builds on**: T-003 (Model Implementation)
- **Blocks**: T-005 (CanvasService Integration Tests)
- **Requirements**: FR-001, FR-002, FR-003, FR-004, FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/config.py | T-006 | `from canvas.config import Settings` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/models/vbu.py | VBU |
| T-003 | backend/canvas/models/canvas.py | Canvas, LifecycleLane, CurrentlyTestingType |
| T-003 | backend/canvas/models/thesis.py | Thesis |
| T-003 | backend/canvas/models/proof_point.py | ProofPoint, ProofPointStatus |
| T-003 | backend/canvas/models/attachment.py | Attachment |

## Scope
- **CREATE**: `backend/canvas/schemas.py`
- **CREATE**: `backend/alembic/versions/002_canvas_tables.py`

## Contract
```python
# Pydantic schemas for API serialization
class VBUCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=255)
    gm_id: UUID

class VBUUpdate(BaseModel):
    name: Optional[str] = Field(None, min_length=1, max_length=255)
    gm_id: Optional[UUID] = None

class CanvasUpdate(BaseModel):
    product_name: Optional[str] = Field(None, max_length=255)
    lifecycle_lane: Optional[LifecycleLane] = None
    success_description: Optional[str] = None
    future_state_intent: Optional[str] = None
    primary_focus: Optional[str] = Field(None, max_length=255)
    resist_doing: Optional[str] = None
    good_discipline: Optional[str] = None
    primary_constraint: Optional[str] = None
    currently_testing_type: Optional[CurrentlyTestingType] = None
    currently_testing_id: Optional[UUID] = None
    portfolio_notes: Optional[str] = None

class ThesisCreate(BaseModel):
    text: str = Field(..., min_length=1)
    order: int = Field(..., ge=1, le=5)

class ProofPointCreate(BaseModel):
    description: str = Field(..., min_length=1)
    status: ProofPointStatus = ProofPointStatus.NOT_STARTED
    evidence_note: Optional[str] = None
    target_review_month: Optional[date] = None

# Alembic migration creates all tables with constraints
def upgrade():
    # Create enums
    op.execute("CREATE TYPE lifecyclelane AS ENUM ('build','sell','milk','reframe')")
    op.execute("CREATE TYPE proofpointstatus AS ENUM ('not_started','in_progress','observed','stalled')")
    op.execute("CREATE TYPE currentlytestingtype AS ENUM ('thesis','proof_point')")
    
    # Create vbus table
    op.create_table('vbus', ...)
    
    # Create canvases table with 1:1 constraint
    op.create_table('canvases', ...)
    
    # Create theses table with order constraint
    op.create_table('theses', ...)
    
    # Create proof_points table
    op.create_table('proof_points', ...)
    
    # Create attachments table with polymorphic constraint
    op.create_table('attachments', ...)
```

## Logic
1. Create Pydantic request schemas with validation rules from spec.md
2. Create Pydantic response schemas for API serialization
3. Generate Alembic migration with all table definitions
4. Add all enum types to database
5. Create tables with foreign keys and constraints per schema.md
6. Add all indexes for performance and uniqueness
7. Add check constraints for data validation

## Verification
- [ ] Migration runs without error
- [ ] All tables created with correct columns and types
- [ ] All foreign key constraints and cascades work
- [ ] All check constraints enforce business rules
- [ ] All indexes created for performance
- [ ] Pydantic schemas validate correctly

## LOC Estimate
~250 lines