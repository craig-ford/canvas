# specs/002-canvas-management/tasks/T-013.md

## Task: AttachmentService Implementation

## Type
implementation

## Context
- **Phase**: Service Layer
- **Builds on**: T-006 (AttachmentService Integration Tests)
- **Blocks**: T-018 (Attachment API Routes)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/config.py | T-006 | `from canvas.config import Settings` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | backend/tests/canvas/test_services_contract.py | AttachmentService interface |
| T-003 | backend/canvas/models/attachment.py | Attachment model |

## Scope
- **CREATE**: `backend/canvas/services/attachment_service.py`

## Contract
```python
import os
import uuid
from pathlib import Path
from typing import Optional
from uuid import UUID
from fastapi import UploadFile, HTTPException
from fastapi.responses import FileResponse
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.attachment import Attachment
from canvas.config import Settings

class AttachmentService:
    """File attachment service with validation and storage"""
    
    def __init__(self, settings: Settings):
        self.upload_dir = Path(settings.upload_dir)
        self.max_size_bytes = settings.max_upload_size_mb * 1024 * 1024
        self.allowed_types = {
            "image/png", "image/jpeg", "image/gif",
            "application/pdf", "text/csv",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        }
    
    async def upload(self, file: UploadFile, vbu_id: UUID, entity_type: str, entity_id: UUID, uploaded_by: UUID, db: AsyncSession, label: Optional[str] = None) -> Attachment:
        """Upload file with validation and storage"""
        ...
    
    async def download(self, attachment_id: UUID, db: AsyncSession) -> FileResponse:
        """Download file with authorization check"""
        ...
    
    async def delete(self, attachment_id: UUID, db: AsyncSession) -> None:
        """Delete file from storage and database"""
        ...
    
    def _validate_file(self, file: UploadFile) -> None:
        """Validate file size and content type"""
        ...
    
    def _generate_storage_path(self, vbu_id: UUID, entity_type: str, filename: str) -> Path:
        """Generate storage path: /uploads/{vbu_id}/{entity_type}/{uuid}.{ext}"""
        ...
    
    async def _save_file(self, file: UploadFile, storage_path: Path) -> None:
        """Save uploaded file to disk atomically"""
        ...
```

## Logic
1. Import required modules: os, uuid, pathlib, fastapi, sqlalchemy
2. Define AttachmentService class with settings injection
3. Implement upload method:
   - Validate file size (max 10MB) and content type
   - Generate UUID-based storage path: /uploads/{vbu_id}/{entity_type}/{uuid}.{ext}
   - Create directory structure if needed
   - Save file atomically using temporary file
   - Create Attachment record in database
   - Return attachment model
4. Implement download method:
   - Query attachment by ID
   - Verify file exists on disk
   - Return FileResponse with proper headers
5. Implement delete method:
   - Query attachment by ID
   - Delete file from filesystem
   - Delete database record
6. Implement validation helper:
   - Check file size against limit
   - Verify content type in allowed list
   - Raise HTTPException for violations
7. Implement path generation helper:
   - Create path with UUID filename to prevent conflicts
   - Preserve original file extension
8. Implement atomic file save helper:
   - Write to temporary file first
   - Move to final location on success

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass

## LOC Estimate
~85 lines