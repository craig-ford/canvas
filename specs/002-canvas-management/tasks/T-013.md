# specs/002-canvas-management/tasks/T-013.md

## Task: AttachmentService Implementation

## Type
implementation

## Context
- **Phase**: Phase 4 - Core Logic
- **Builds on**: T-011 (Attachment unit tests)
- **Blocks**: T-018 (Attachment API endpoints)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-011 | backend/tests/unit/test_attachment_service.py | Test contracts and expected behavior |

## Scope
- **MODIFY**: `backend/canvas/services/attachment_service.py`

## Contract
```python
import uuid
import aiofiles
from pathlib import Path
from typing import Optional
from fastapi import UploadFile, HTTPException
from fastapi.responses import FileResponse
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from canvas.models.attachment import Attachment

class AttachmentService:
    def __init__(self, upload_dir: str, max_size_mb: int = 10):
        self.upload_dir = Path(upload_dir)
        self.max_size_bytes = max_size_mb * 1024 * 1024
        self.allowed_types = {
            "image/png", "image/jpeg", "image/gif",
            "application/pdf", "text/csv",
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        }
        self.upload_dir.mkdir(parents=True, exist_ok=True)

    async def upload(
        self,
        file: UploadFile,
        vbu_id: str,
        entity_type: str,
        entity_id: str,
        uploaded_by: str,
        db: AsyncSession,
        label: Optional[str] = None
    ) -> Attachment:
        """Upload file with validation and storage"""
        ...

    async def download(self, attachment_id: str, db: AsyncSession) -> FileResponse:
        """Download file with proper headers"""
        ...

    async def delete(self, attachment_id: str, db: AsyncSession) -> None:
        """Delete file from disk and database"""
        ...

    def _validate_file_size(self, size: int) -> bool:
        """Validate file size against limit"""
        ...

    def _validate_content_type(self, content_type: str) -> bool:
        """Validate MIME type against allowed list"""
        ...

    def _generate_storage_path(self, filename: str, vbu_id: str, entity_type: str) -> Path:
        """Generate unique storage path with UUID"""
        ...
```

## Logic
1. Initialize service with upload directory and size limits
2. Implement upload method:
   - Validate file size and content type
   - Generate UUID-based storage path
   - Save file atomically using aiofiles
   - Create attachment record in database
3. Implement download method:
   - Fetch attachment from database
   - Return FileResponse with proper headers
4. Implement delete method:
   - Remove file from filesystem
   - Delete database record
5. Implement validation helpers for size and MIME type
6. Implement storage path generator with UUID and extension

## Verification
- [ ] File size validation enforces 10MB limit
- [ ] Content type validation uses allowed MIME types
- [ ] Storage paths are unique and organized by VBU/entity
- [ ] File operations are atomic and handle errors
- [ ] Database operations use proper async patterns

## LOC Estimate
~80 lines