# specs/002-canvas-management/tasks/T-005.md

## Task: Model Relationship Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-003 (SQLAlchemy models)
- **Blocks**: T-012, T-013 (Service implementations)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-core-models | backend/models/base.py | 001A-infrastructure/T-006 | `from backend.models.base import TimestampMixin` |
| 001A-infrastructure | backend/db.py | 001A-infrastructure/T-007 | `from backend.db import get_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/models/*.py | All model classes: VBU, Canvas, Thesis, ProofPoint, Attachment |

## Scope
- **CREATE**: `backend/tests/test_canvas_models.py`

## Contract
```python
import pytest
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.exc import IntegrityError
from canvas.models.vbu import VBU
from canvas.models.canvas import Canvas
from canvas.models.thesis import Thesis
from canvas.models.proof_point import ProofPoint
from canvas.models.attachment import Attachment

@pytest.mark.asyncio
async def test_vbu_canvas_one_to_one_relationship(db_session: AsyncSession):
    """Test VBU has exactly one Canvas"""
    # Create VBU and Canvas
    # Verify relationship works both ways
    # Verify cascade delete
    assert canvas.vbu_id == vbu.id

@pytest.mark.asyncio
async def test_canvas_thesis_ordering_constraint(db_session: AsyncSession):
    """Test thesis ordering constraints and uniqueness"""
    # Create canvas with 5 theses
    # Verify order constraint (1-5)
    # Test duplicate order raises IntegrityError
    assert len(canvas.theses) == 5

@pytest.mark.asyncio
async def test_thesis_proof_point_cascade_delete(db_session: AsyncSession):
    """Test deleting thesis cascades to proof points"""
    # Create thesis with proof points
    # Delete thesis
    # Verify proof points are deleted
    assert proof_point_count == 0

@pytest.mark.asyncio
async def test_proof_point_attachment_relationship(db_session: AsyncSession):
    """Test proof point can have multiple attachments"""
    # Create proof point with attachments
    # Verify relationship
    # Test cascade delete
    assert len(proof_point.attachments) == 2

@pytest.mark.asyncio
async def test_attachment_single_parent_constraint(db_session: AsyncSession):
    """Test attachment belongs to exactly one parent"""
    # Test attachment with proof_point_id only
    # Test attachment with monthly_review_id only
    # Test both set raises IntegrityError
    # Test neither set raises IntegrityError
    with pytest.raises(IntegrityError):
        await db_session.commit()

@pytest.mark.asyncio
async def test_currently_testing_polymorphic_relationship(db_session: AsyncSession):
    """Test currently_testing pointer referential integrity"""
    # Create canvas pointing to thesis
    # Create canvas pointing to proof point
    # Test invalid ID raises constraint error
    assert canvas.currently_testing_type == "thesis"

@pytest.mark.asyncio
async def test_model_timestamps_auto_update(db_session: AsyncSession):
    """Test TimestampMixin auto-updates timestamps"""
    # Create model
    # Update model
    # Verify updated_at changed
    assert vbu.updated_at > vbu.created_at
```

## Logic
1. Import all model classes and test dependencies
2. Test VBU-Canvas 1:1 relationship and cascade
3. Test thesis ordering constraints and uniqueness
4. Test cascade deletes work correctly
5. Test attachment polymorphic relationships
6. Test currently_testing pointer integrity
7. Test timestamp auto-updates

## Verification
- [ ] All relationship tests pass
- [ ] Constraint violations properly raise IntegrityError
- [ ] Cascade deletes work as expected
- [ ] Polymorphic relationships validated

## LOC Estimate
~150 lines