# specs/002-canvas-management/tasks/T-009.md

## Task: Thesis Service Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: None
- **Blocks**: T-016 (Thesis API Endpoints)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/auth/dependencies.py | 001-auth/T-015 | `from auth.dependencies import get_current_user, require_role` |
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/services/canvas_service.py | CanvasService interface |
| T-003 | backend/canvas/models/ | Thesis, Canvas, ProofPoint models |

## Scope
- **CREATE**: `backend/tests/test_thesis_service.py`

## Contract
```python
class TestThesisService:
    """Test thesis CRUD, ordering constraints, cascade deletes."""
    
    async def test_create_thesis_valid_order(self, db_session, gm_user, sample_canvas):
        """Create thesis with valid order (1-5)."""
        assert result.text == "Test thesis"
        assert result.order == 1
        assert result.canvas_id == sample_canvas.id
    
    async def test_create_thesis_max_limit_exceeded(self, db_session, gm_user, canvas_with_5_theses):
        """Creating 6th thesis raises ValidationError."""
        with pytest.raises(ValidationError, match="Maximum 5 theses"):
            ...
    
    async def test_create_thesis_auto_order_assignment(self, db_session, gm_user, canvas_with_2_theses):
        """New thesis gets next available order automatically."""
        assert result.order == 3
    
    async def test_list_theses_with_proof_points(self, db_session, sample_canvas_with_data):
        """List theses includes nested proof points."""
        assert len(result) == 2
        assert len(result[0].proof_points) == 1
        assert result[0].order < result[1].order  # Ordered correctly
    
    async def test_update_thesis_text(self, db_session, gm_user, sample_thesis):
        """Update thesis text with authorization."""
        assert result.text == "Updated thesis text"
        assert result.order == sample_thesis.order  # Order unchanged
    
    async def test_update_thesis_unauthorized(self, db_session, other_gm_user, sample_thesis):
        """GM cannot update other GM's thesis."""
        with pytest.raises(ForbiddenError):
            ...
    
    async def test_delete_thesis_cascade_proof_points(self, db_session, gm_user, thesis_with_proof_points):
        """Deleting thesis cascades to proof points."""
        # Verify thesis and proof points are deleted
        assert deleted_thesis is None
        assert len(remaining_proof_points) == 0
    
    async def test_delete_thesis_reorder_remaining(self, db_session, gm_user, canvas_with_3_theses):
        """Deleting middle thesis reorders remaining theses."""
        # Delete thesis with order=2, verify orders become 1,2
        assert remaining_theses[0].order == 1
        assert remaining_theses[1].order == 2
    
    async def test_reorder_theses_valid_sequence(self, db_session, gm_user, canvas_with_3_theses):
        """Reorder theses with valid order sequence."""
        # Reorder: [1,2,3] -> [3,1,2]
        assert reordered[0].order == 1  # Was order 3
        assert reordered[1].order == 2  # Was order 1
        assert reordered[2].order == 3  # Was order 2
    
    async def test_reorder_theses_invalid_sequence(self, db_session, gm_user, canvas_with_3_theses):
        """Reorder with gaps or duplicates raises ValidationError."""
        with pytest.raises(ValidationError, match="Invalid order sequence"):
            ...
    
    async def test_thesis_order_constraint_violation(self, db_session, sample_canvas):
        """Direct order constraint violation raises IntegrityError."""
        # Try to create two theses with same order
        with pytest.raises(IntegrityError):
            ...
    
    async def test_thesis_text_validation(self, db_session, gm_user, sample_canvas):
        """Empty or whitespace-only thesis text raises ValidationError."""
        with pytest.raises(ValidationError, match="Text cannot be empty"):
            ...
```

## Logic
1. Import CanvasService, models, auth dependencies
2. Define test fixtures for theses and canvases
3. Test thesis creation with order validation
4. Test max thesis limit enforcement (5 per canvas)
5. Test thesis listing with nested proof points
6. Test thesis updates with authorization
7. Test thesis deletion with cascade behavior
8. Test thesis reordering operations
9. Test order constraint violations
10. Test text validation requirements

## Verification
- [ ] All test methods contain assertions or pytest.raises
- [ ] Order constraints tested (max 5, unique per canvas)
- [ ] Cascade deletion tested for proof points
- [ ] Reordering logic tested with edge cases
- [ ] Authorization tested for all operations
- [ ] Text validation tested for empty/whitespace

## LOC Estimate
~160 lines