# specs/002-canvas-management/tasks/T-023.md

## Task: Canvas API Client

## Type
implementation

## Context
- **Phase**: UI Layer
- **Builds on**: T-015 (Canvas API Routes), T-016 (Thesis API Routes), T-017 (ProofPoint API Routes), T-018 (Attachment API Routes)
- **Blocks**: T-024 (Canvas Page Integration)
- **Requirements**: FR-002, FR-003, FR-004, FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-015 | backend/canvas/routes/canvas.py | Canvas API endpoints |
| T-016 | backend/canvas/routes/thesis.py | Thesis API endpoints |
| T-017 | backend/canvas/routes/proof_point.py | ProofPoint API endpoints |
| T-018 | backend/canvas/routes/attachment.py | Attachment API endpoints |

## Scope
- **CREATE**: `frontend/src/api/canvas.ts`

## Contract
```typescript
import axios, { AxiosResponse } from 'axios';

// Types
interface VBU {
  id: string;
  name: string;
  gm_id: string;
  gm_name: string;
  created_at: string;
  updated_at: string;
  updated_by?: string;
}

interface Canvas {
  id: string;
  vbu_id: string;
  product_name?: string;
  lifecycle_lane: 'build' | 'sell' | 'milk' | 'reframe';
  success_description?: string;
  future_state_intent?: string;
  primary_focus?: string;
  resist_doing?: string;
  good_discipline?: string;
  primary_constraint?: string;
  currently_testing_type?: 'thesis' | 'proof_point';
  currently_testing_id?: string;
  portfolio_notes?: string;
  theses: Thesis[];
  created_at: string;
  updated_at: string;
  updated_by?: string;
}

interface Thesis {
  id: string;
  order: number;
  text: string;
  proof_points: ProofPoint[];
  created_at: string;
  updated_at: string;
}

interface ProofPoint {
  id: string;
  description: string;
  status: 'not_started' | 'in_progress' | 'observed' | 'stalled';
  evidence_note?: string;
  target_review_month?: string;
  attachments: Attachment[];
  created_at: string;
  updated_at: string;
}

interface Attachment {
  id: string;
  filename: string;
  content_type: string;
  size_bytes: number;
  label?: string;
  uploaded_by: string;
  created_at: string;
}

interface ApiResponse<T> {
  data: T;
  meta: {
    timestamp: string;
    total?: number;
    page?: number;
    per_page?: number;
  };
}

// API Client
const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000';

const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Add auth token to requests
apiClient.interceptors.request.use((config) => {
  const token = localStorage.getItem('access_token');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// VBU Operations
export const listVbus = async (params?: { page?: number; per_page?: number; gm_id?: string; name?: string }): Promise<VBU[]> => {
  const response: AxiosResponse<ApiResponse<VBU[]>> = await apiClient.get('/api/vbus', { params });
  return response.data.data;
};

export const getVbu = async (id: string): Promise<VBU> => {
  const response: AxiosResponse<ApiResponse<VBU>> = await apiClient.get(`/api/vbus/${id}`);
  return response.data.data;
};

export const createVbu = async (data: { name: string; gm_id: string }): Promise<VBU> => {
  const response: AxiosResponse<ApiResponse<VBU>> = await apiClient.post('/api/vbus', data);
  return response.data.data;
};

export const updateVbu = async (id: string, data: { name?: string; gm_id?: string }): Promise<VBU> => {
  const response: AxiosResponse<ApiResponse<VBU>> = await apiClient.patch(`/api/vbus/${id}`, data);
  return response.data.data;
};

export const deleteVbu = async (id: string): Promise<void> => {
  await apiClient.delete(`/api/vbus/${id}`);
};

// Canvas Operations
export const getCanvas = async (vbuId: string): Promise<Canvas> => {
  const response: AxiosResponse<ApiResponse<Canvas>> = await apiClient.get(`/api/vbus/${vbuId}/canvas`);
  return response.data.data;
};

export const updateCanvas = async (vbuId: string, data: Partial<Canvas>): Promise<Canvas> => {
  const response: AxiosResponse<ApiResponse<Canvas>> = await apiClient.put(`/api/vbus/${vbuId}/canvas`, data);
  return response.data.data;
};

// Thesis Operations
export const listTheses = async (canvasId: string): Promise<Thesis[]> => {
  const response: AxiosResponse<ApiResponse<Thesis[]>> = await apiClient.get(`/api/canvases/${canvasId}/theses`);
  return response.data.data;
};

export const createThesis = async (canvasId: string, data: { text: string; order: number }): Promise<Thesis> => {
  const response: AxiosResponse<ApiResponse<Thesis>> = await apiClient.post(`/api/canvases/${canvasId}/theses`, data);
  return response.data.data;
};

export const updateThesis = async (id: string, data: { text: string }): Promise<Thesis> => {
  const response: AxiosResponse<ApiResponse<Thesis>> = await apiClient.patch(`/api/theses/${id}`, data);
  return response.data.data;
};

export const deleteThesis = async (id: string): Promise<void> => {
  await apiClient.delete(`/api/theses/${id}`);
};

export const reorderTheses = async (canvasId: string, thesisOrders: Array<{ id: string; order: number }>): Promise<Thesis[]> => {
  const response: AxiosResponse<ApiResponse<Thesis[]>> = await apiClient.put(`/api/canvases/${canvasId}/theses/reorder`, {
    thesis_orders: thesisOrders
  });
  return response.data.data;
};

// ProofPoint Operations
export const listProofPoints = async (thesisId: string): Promise<ProofPoint[]> => {
  const response: AxiosResponse<ApiResponse<ProofPoint[]>> = await apiClient.get(`/api/theses/${thesisId}/proof-points`);
  return response.data.data;
};

export const createProofPoint = async (thesisId: string, data: {
  description: string;
  status?: 'not_started' | 'in_progress' | 'observed' | 'stalled';
  evidence_note?: string;
  target_review_month?: string;
}): Promise<ProofPoint> => {
  const response: AxiosResponse<ApiResponse<ProofPoint>> = await apiClient.post(`/api/theses/${thesisId}/proof-points`, data);
  return response.data.data;
};

export const updateProofPoint = async (id: string, data: {
  description?: string;
  status?: 'not_started' | 'in_progress' | 'observed' | 'stalled';
  evidence_note?: string;
  target_review_month?: string;
}): Promise<ProofPoint> => {
  const response: AxiosResponse<ApiResponse<ProofPoint>> = await apiClient.patch(`/api/proof-points/${id}`, data);
  return response.data.data;
};

export const deleteProofPoint = async (id: string): Promise<void> => {
  await apiClient.delete(`/api/proof-points/${id}`);
};

// Attachment Operations
export const uploadAttachment = async (file: File, options: {
  proof_point_id?: string;
  monthly_review_id?: string;
  label?: string;
}): Promise<Attachment> => {
  const formData = new FormData();
  formData.append('file', file);
  if (options.proof_point_id) formData.append('proof_point_id', options.proof_point_id);
  if (options.monthly_review_id) formData.append('monthly_review_id', options.monthly_review_id);
  if (options.label) formData.append('label', options.label);

  const response: AxiosResponse<ApiResponse<Attachment>> = await apiClient.post('/api/attachments', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
  return response.data.data;
};

export const downloadAttachment = async (id: string): Promise<Blob> => {
  const response = await apiClient.get(`/api/attachments/${id}`, { responseType: 'blob' });
  return response.data;
};

export const deleteAttachment = async (id: string): Promise<void> => {
  await apiClient.delete(`/api/attachments/${id}`);
};
```

## Logic
1. Import axios for HTTP client with TypeScript types
2. Define TypeScript interfaces matching backend response schemas
3. Create axios instance with base URL from environment variable
4. Add request interceptor to include JWT token from localStorage
5. Implement VBU operations: listVbus, getVbu, createVbu, updateVbu, deleteVbu
6. Implement Canvas operations: getCanvas, updateCanvas
7. Implement Thesis operations: listTheses, createThesis, updateThesis, deleteThesis, reorderTheses
8. Implement ProofPoint operations: listProofPoints, createProofPoint, updateProofPoint, deleteProofPoint
9. Implement Attachment operations: uploadAttachment, downloadAttachment, deleteAttachment
10. Handle multipart form data for file uploads with proper headers
11. Return typed responses unwrapping data from API response envelope

## Verification
- [ ] All API endpoints wrapped with proper TypeScript types
- [ ] JWT token automatically included in request headers
- [ ] File upload handles multipart form data correctly
- [ ] Response types match backend API contracts
- [ ] Environment variable used for base URL configuration

## LOC Estimate
~180 lines