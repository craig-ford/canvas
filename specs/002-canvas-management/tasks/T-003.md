# specs/002-canvas-management/tasks/T-003.md

## Task: SQLAlchemy Models

## Type
implementation

## Context
- **Phase**: Data Layer
- **Builds on**: None
- **Blocks**: T-004, T-005, T-007, T-008, T-009, T-010, T-011
- **Requirements**: FR-001, FR-002, FR-003, FR-004, FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/models/__init__.py | 001A-infrastructure/T-006 | `from canvas.models import TimestampMixin` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| None | None | None |

## Scope
- **CREATE**: `backend/canvas/models/vbu.py`
- **CREATE**: `backend/canvas/models/canvas.py`
- **CREATE**: `backend/canvas/models/thesis.py`
- **CREATE**: `backend/canvas/models/proof_point.py`
- **CREATE**: `backend/canvas/models/attachment.py`
- **MODIFY**: `backend/canvas/models/__init__.py`

## Contract
```python
# VBU Model
from sqlalchemy import Column, String, ForeignKey, Index, CheckConstraint
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from canvas.models import TimestampMixin, Base

class VBU(TimestampMixin, Base):
    __tablename__ = "vbus"
    
    name = Column(String(255), nullable=False, CheckConstraint("LENGTH(TRIM(name)) > 0"))
    gm_id = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="RESTRICT"), nullable=False)
    updated_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"))
    
    # Relationships
    gm = relationship("User", foreign_keys=[gm_id])
    canvas = relationship("Canvas", back_populates="vbu", uselist=False, cascade="all, delete-orphan")
    
    __table_args__ = (
        Index("ix_vbus_gm_id", "gm_id"),
    )

# Canvas Model
from sqlalchemy import Column, String, Text, Enum, ForeignKey, Index, CheckConstraint, UniqueConstraint
from canvas.models.enums import LifecycleLane, CurrentlyTestingType

class Canvas(TimestampMixin, Base):
    __tablename__ = "canvases"
    
    vbu_id = Column(UUID(as_uuid=True), ForeignKey("vbus.id", ondelete="CASCADE"), unique=True, nullable=False)
    product_name = Column(String(255), CheckConstraint("product_name IS NULL OR LENGTH(TRIM(product_name)) > 0"))
    lifecycle_lane = Column(Enum(LifecycleLane), nullable=False, default=LifecycleLane.BUILD)
    success_description = Column(Text)
    future_state_intent = Column(Text)
    primary_focus = Column(String(255))
    resist_doing = Column(Text)
    good_discipline = Column(Text)
    primary_constraint = Column(Text)
    currently_testing_type = Column(Enum(CurrentlyTestingType))
    currently_testing_id = Column(UUID(as_uuid=True))
    portfolio_notes = Column(Text)
    updated_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="SET NULL"))
    
    # Relationships
    vbu = relationship("VBU", back_populates="canvas")
    theses = relationship("Thesis", back_populates="canvas", cascade="all, delete-orphan", order_by="Thesis.order")
    
    __table_args__ = (
        CheckConstraint("(currently_testing_type IS NULL) = (currently_testing_id IS NULL)", name="ck_currently_testing_consistency"),
        Index("uq_canvases_vbu_id", "vbu_id", unique=True),
    )

# Thesis Model
from sqlalchemy import Column, Integer, Text, ForeignKey, Index, CheckConstraint, UniqueConstraint

class Thesis(TimestampMixin, Base):
    __tablename__ = "theses"
    
    canvas_id = Column(UUID(as_uuid=True), ForeignKey("canvases.id", ondelete="CASCADE"), nullable=False)
    order = Column(Integer, CheckConstraint("order BETWEEN 1 AND 5"), nullable=False)
    text = Column(Text, nullable=False, CheckConstraint("LENGTH(TRIM(text)) > 0"))
    
    # Relationships
    canvas = relationship("Canvas", back_populates="theses")
    proof_points = relationship("ProofPoint", back_populates="thesis", cascade="all, delete-orphan")
    
    __table_args__ = (
        UniqueConstraint("canvas_id", "order", name="uq_theses_canvas_order"),
        Index("ix_theses_canvas_id", "canvas_id"),
    )

# ProofPoint Model
from sqlalchemy import Column, Text, Date, ForeignKey, Index, CheckConstraint
from canvas.models.enums import ProofPointStatus

class ProofPoint(TimestampMixin, Base):
    __tablename__ = "proof_points"
    
    thesis_id = Column(UUID(as_uuid=True), ForeignKey("theses.id", ondelete="CASCADE"), nullable=False)
    description = Column(Text, nullable=False, CheckConstraint("LENGTH(TRIM(description)) > 0"))
    status = Column(Enum(ProofPointStatus), nullable=False, default=ProofPointStatus.NOT_STARTED)
    evidence_note = Column(Text)
    target_review_month = Column(Date)
    
    # Relationships
    thesis = relationship("Thesis", back_populates="proof_points")
    attachments = relationship("Attachment", back_populates="proof_point", cascade="all, delete-orphan")
    
    __table_args__ = (
        Index("ix_proof_points_thesis_id", "thesis_id"),
        Index("ix_proof_points_status", "status"),
    )

# Attachment Model
from sqlalchemy import Column, String, Integer, ForeignKey, Index, CheckConstraint

class Attachment(TimestampMixin, Base):
    __tablename__ = "attachments"
    
    proof_point_id = Column(UUID(as_uuid=True), ForeignKey("proof_points.id", ondelete="CASCADE"))
    monthly_review_id = Column(UUID(as_uuid=True), ForeignKey("monthly_reviews.id", ondelete="CASCADE"))
    filename = Column(String(255), nullable=False, CheckConstraint("LENGTH(TRIM(filename)) > 0"))
    storage_path = Column(String(1024), nullable=False, unique=True, CheckConstraint("LENGTH(TRIM(storage_path)) > 0"))
    content_type = Column(String(128), nullable=False)
    size_bytes = Column(Integer, nullable=False, CheckConstraint("size_bytes BETWEEN 1 AND 10485760"))
    label = Column(String(255), CheckConstraint("label IS NULL OR LENGTH(TRIM(label)) > 0"))
    uploaded_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="RESTRICT"), nullable=False)
    
    # Relationships
    proof_point = relationship("ProofPoint", back_populates="attachments")
    uploader = relationship("User")
    
    __table_args__ = (
        CheckConstraint("(proof_point_id IS NOT NULL AND monthly_review_id IS NULL) OR (proof_point_id IS NULL AND monthly_review_id IS NOT NULL)", name="ck_attachment_single_parent"),
        Index("ix_attachments_proof_point_id", "proof_point_id"),
        Index("ix_attachments_monthly_review_id", "monthly_review_id"),
        Index("uq_attachments_storage_path", "storage_path", unique=True),
    )

# Enums
from enum import Enum

class LifecycleLane(str, Enum):
    BUILD = "build"
    SELL = "sell"
    MILK = "milk"
    REFRAME = "reframe"

class CurrentlyTestingType(str, Enum):
    THESIS = "thesis"
    PROOF_POINT = "proof_point"

class ProofPointStatus(str, Enum):
    NOT_STARTED = "not_started"
    IN_PROGRESS = "in_progress"
    OBSERVED = "observed"
    STALLED = "stalled"
```

## Logic
1. Create VBU model with GM relationship and constraints
2. Create Canvas model with lifecycle lane and polymorphic currently_testing
3. Create Thesis model with ordering constraints (1-5 per canvas)
4. Create ProofPoint model with status enum and evidence tracking
5. Create Attachment model with polymorphic parent (proof_point or monthly_review)
6. Define enums for lifecycle lanes, testing types, and proof point status
7. Set up all relationships with proper cascade behavior
8. Add database indexes for performance and constraints

## Verification
- [ ] All models inherit from TimestampMixin
- [ ] Foreign key relationships defined correctly
- [ ] Check constraints enforce business rules
- [ ] Unique constraints prevent duplicates
- [ ] Cascade deletes configured properly
- [ ] Enums defined for all status fields

## LOC Estimate
~250 lines