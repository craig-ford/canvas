# specs/002-canvas-management/tasks/T-003.md

## Task: Model Implementation

## Type
implementation

## Context
- **Phase**: Data Layer
- **Builds on**: T-001 (Model Contract Tests)
- **Blocks**: T-004 (Database Migration + Pydantic Schemas)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/models/__init__.py | T-006 | `from canvas.models import TimestampMixin` |
| 001-auth | backend/canvas/models/user.py | T-001 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/tests/canvas/test_models_contract.py | VBU, Canvas, Thesis, ProofPoint, Attachment, LifecycleLane, ProofPointStatus, CurrentlyTestingType |

## Scope
- **CREATE**: `backend/canvas/models/vbu.py`
- **CREATE**: `backend/canvas/models/canvas.py`
- **CREATE**: `backend/canvas/models/thesis.py`
- **CREATE**: `backend/canvas/models/proof_point.py`
- **CREATE**: `backend/canvas/models/attachment.py`
- **CREATE**: `backend/canvas/models/__init__.py`

## Contract
```python
# From T-001 contract tests, these models must provide:

class VBU(TimestampMixin, Base):
    """VBU model with GM ownership and canvas relationship."""
    __tablename__ = "vbus"
    
    name: Mapped[str]
    gm_id: Mapped[UUID]
    updated_by: Mapped[Optional[UUID]]
    canvas: Mapped["Canvas"]

class Canvas(TimestampMixin, Base):
    """Canvas model with VBU 1:1 relationship and nested entities."""
    __tablename__ = "canvases"
    
    vbu_id: Mapped[UUID]
    lifecycle_lane: Mapped[LifecycleLane]
    currently_testing_type: Mapped[Optional[CurrentlyTestingType]]
    currently_testing_id: Mapped[Optional[UUID]]
    theses: Mapped[List["Thesis"]]

class Thesis(TimestampMixin, Base):
    """Thesis model with canvas relationship and proof points."""
    __tablename__ = "theses"
    
    canvas_id: Mapped[UUID]
    order: Mapped[int]
    text: Mapped[str]
    proof_points: Mapped[List["ProofPoint"]]

class ProofPoint(TimestampMixin, Base):
    """ProofPoint model with thesis relationship and attachments."""
    __tablename__ = "proof_points"
    
    thesis_id: Mapped[UUID]
    description: Mapped[str]
    status: Mapped[ProofPointStatus]
    attachments: Mapped[List["Attachment"]]

class Attachment(TimestampMixin, Base):
    """Attachment model with polymorphic parent relationship."""
    __tablename__ = "attachments"
    
    proof_point_id: Mapped[Optional[UUID]]
    monthly_review_id: Mapped[Optional[UUID]]
    filename: Mapped[str]
    storage_path: Mapped[str]
    content_type: Mapped[str]
    size_bytes: Mapped[int]
    uploaded_by: Mapped[UUID]

# Enums
class LifecycleLane(str, Enum):
    BUILD = "build"
    SELL = "sell"
    MILK = "milk"
    REFRAME = "reframe"

class ProofPointStatus(str, Enum):
    NOT_STARTED = "not_started"
    IN_PROGRESS = "in_progress"
    OBSERVED = "observed"
    STALLED = "stalled"

class CurrentlyTestingType(str, Enum):
    THESIS = "thesis"
    PROOF_POINT = "proof_point"
```

## Logic
1. Create enum classes with UPPER_SNAKE_CASE values
2. Implement VBU model with name validation and GM relationship
3. Implement Canvas model with lifecycle lane and polymorphic currently_testing
4. Implement Thesis model with order constraints and canvas relationship
5. Implement ProofPoint model with status enum and thesis relationship
6. Implement Attachment model with polymorphic parent and file metadata
7. Add all foreign key constraints and indexes per schema.md
8. Create __init__.py with all exports

## Verification
- [ ] All models inherit from TimestampMixin and Base
- [ ] All foreign keys have proper constraints and cascades
- [ ] All check constraints match schema.md specifications
- [ ] All indexes created for performance
- [ ] T-001 contract tests pass

## LOC Estimate
~300 lines