# specs/002-canvas-management/tasks/T-016.md

## Task: Thesis API Endpoints

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-009 (Thesis Service Unit Tests), T-012 (CanvasService Implementation)
- **Blocks**: T-019 (CLI commands)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-012 | backend/canvas/services/canvas_service.py | CanvasService class |

## Scope
- **CREATE**: `backend/canvas/routes/thesis.py`

## Contract
```python
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.ext.asyncio import AsyncSession
from typing import List
from uuid import UUID

from canvas.auth.dependencies import get_current_user, require_role
from canvas.db import get_db_session
from canvas.services.canvas_service import CanvasService
from canvas.schemas.thesis import ThesisCreate, ThesisUpdate, ThesisResponse, ThesesReorder
from canvas.models.user import User
from canvas import success_response, list_response

router = APIRouter(prefix="/api", tags=["thesis"])

@router.get("/canvases/{canvas_id}/theses")
async def list_theses(
    canvas_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """List theses with proof points for a canvas."""
    ...

@router.post("/canvases/{canvas_id}/theses")
async def create_thesis(
    canvas_id: UUID,
    thesis_data: ThesisCreate,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Create new thesis for canvas."""
    ...

@router.patch("/theses/{thesis_id}")
async def update_thesis(
    thesis_id: UUID,
    thesis_data: ThesisUpdate,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Update thesis text."""
    ...

@router.delete("/theses/{thesis_id}")
async def delete_thesis(
    thesis_id: UUID,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Delete thesis (cascade to proof points)."""
    ...

@router.put("/canvases/{canvas_id}/theses/reorder")
async def reorder_theses(
    canvas_id: UUID,
    reorder_data: ThesesReorder,
    current_user: User = Depends(require_role(["admin", "gm"])),
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Reorder theses within canvas."""
    ...
```

## Logic
1. Import CanvasService from T-012
2. Import auth dependencies from 001-auth
3. Import response helpers from canvas.__init__
4. Define router with /api prefix
5. Implement list_theses - get canvas, check authorization, return theses with proof points
6. Implement create_thesis - validate canvas ownership, create thesis, return response
7. Implement update_thesis - validate ownership, update text, return response
8. Implement delete_thesis - validate ownership, cascade delete, return success
9. Implement reorder_theses - validate ownership, update order values, return response

## Verification
- [ ] All endpoints require proper authentication
- [ ] GM users can only access their own VBU's canvases
- [ ] Admin users can access all canvases
- [ ] Thesis ordering constraints enforced (1-5, unique per canvas)
- [ ] Cascade deletes work for thesis â†’ proof points
- [ ] Response envelopes follow standard format

## LOC Estimate
~120 lines