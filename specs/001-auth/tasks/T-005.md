# specs/001-auth/tasks/T-005.md

## Task: Auth Routes Integration Tests

## Type
integration-test

## Context
- **Phase**: Test Infrastructure
- **Builds on**: T-002 (AuthService), T-004 (Auth Dependencies)
- **Blocks**: T-016

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/__init__.py | 001A-infrastructure/T-006 | `from canvas import success_response` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/models/user.py | User model, UserRole enum |
| T-002 | backend/canvas/auth/service.py | AuthService class |
| T-004 | backend/canvas/auth/dependencies.py | get_current_user, require_role |

## Scope
- **CREATE**: `backend/tests/auth/test_auth_routes_integration.py`

## Contract
```python
import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User, UserRole

class TestAuthRoutesIntegration:
    """Integration tests for auth routes with real database and JWT."""
    
    async def test_register_user_success(self, client: AsyncClient, db: AsyncSession):
        """Test successful user registration."""
        assert True  # Placeholder - will test POST /api/auth/register
    
    async def test_register_duplicate_email(self, client: AsyncClient, db: AsyncSession):
        """Test registration with duplicate email returns 409."""
        assert True  # Placeholder - will test duplicate email conflict
    
    async def test_login_success(self, client: AsyncClient, db: AsyncSession):
        """Test successful login returns tokens and user data."""
        assert True  # Placeholder - will test POST /api/auth/login
    
    async def test_login_invalid_credentials(self, client: AsyncClient, db: AsyncSession):
        """Test login with invalid credentials returns 401."""
        assert True  # Placeholder - will test invalid email/password
    
    async def test_login_account_locked(self, client: AsyncClient, db: AsyncSession):
        """Test login with locked account returns 429."""
        assert True  # Placeholder - will test account lockout
    
    async def test_refresh_token_success(self, client: AsyncClient, db: AsyncSession):
        """Test successful token refresh."""
        assert True  # Placeholder - will test POST /api/auth/refresh
    
    async def test_refresh_token_invalid(self, client: AsyncClient, db: AsyncSession):
        """Test refresh with invalid token returns 401."""
        assert True  # Placeholder - will test invalid refresh token
    
    async def test_get_current_user_success(self, client: AsyncClient, db: AsyncSession):
        """Test GET /api/auth/me with valid token."""
        assert True  # Placeholder - will test authenticated user profile
    
    async def test_get_current_user_invalid_token(self, client: AsyncClient, db: AsyncSession):
        """Test GET /api/auth/me with invalid token returns 401."""
        assert True  # Placeholder - will test invalid token handling
    
    async def test_rate_limiting_login(self, client: AsyncClient, db: AsyncSession):
        """Test login rate limiting after 5 failed attempts."""
        assert True  # Placeholder - will test rate limiting
```

## Logic
1. Import test dependencies (pytest, httpx, AsyncSession)
2. Import User model and UserRole from T-001
3. Import AuthService from T-002
4. Import auth dependencies from T-004
5. Create integration test class with real database
6. Test user registration endpoint:
   - Valid registration creates user and returns profile
   - Duplicate email returns 409 CONFLICT
   - Invalid data returns 422 VALIDATION_ERROR
7. Test login endpoint:
   - Valid credentials return access/refresh tokens + user data
   - Invalid credentials return 401 with generic message
   - Account lockout after 5 failed attempts returns 429
8. Test token refresh endpoint:
   - Valid refresh token returns new access token
   - Invalid/expired refresh token returns 401
9. Test current user profile endpoint:
   - Valid JWT returns user profile without password
   - Invalid JWT returns 401
10. Test rate limiting on login endpoint
11. Use real PostgreSQL database for all tests
12. Use real JWT tokens and bcrypt hashing

## Verification
- [ ] All auth endpoints tested with real database
- [ ] JWT token creation and verification working
- [ ] Password hashing with bcrypt functional
- [ ] Rate limiting prevents brute force attacks
- [ ] Account lockout mechanism working
- [ ] Error responses match API specification
- [ ] All integration tests pass

## LOC Estimate
~200 lines