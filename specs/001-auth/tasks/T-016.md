# specs/001-auth/tasks/T-016.md

## Task: Auth Routes Implementation

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-005, T-006, T-007 (Integration Tests), T-013 (AuthService), T-014 (UserService), T-015 (Auth Dependencies)
- **Blocks**: None (final implementation task)
- **Requirements**: FR-001, FR-002, FR-003, FR-004, FR-006

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | canvas/__init__.py | 001A-infrastructure/T-006 | `from canvas import success_response` |
| 001A-infrastructure | canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-013 | backend/canvas/auth/service.py | `from canvas.auth.service import AuthService` |
| T-014 | backend/canvas/auth/user_service.py | `from canvas.auth.user_service import UserService` |
| T-015 | backend/canvas/auth/dependencies.py | `from canvas.auth.dependencies import get_current_user, require_role` |

## Scope
- **CREATE**: `backend/canvas/auth/routes.py`

## Contract
```python
from fastapi import APIRouter, Depends, HTTPException, status, Response
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.service import AuthService
from canvas.auth.user_service import UserService
from canvas.auth.dependencies import get_current_user, require_role
from canvas.auth.schemas import LoginRequest, TokenResponse, UserCreate, UserResponse
from canvas.models.user import User, UserRole
from canvas.db import get_db_session
from canvas import success_response, list_response

router = APIRouter(prefix="/api/auth", tags=["auth"])
auth_service = AuthService()
user_service = UserService()

@router.post("/register", response_model=dict, status_code=201)
async def register_user(
    user_data: UserCreate,
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(require_role(UserRole.ADMIN))
) -> dict:
    """Register new user (admin only)."""
    ...

@router.post("/login", response_model=dict)
async def login(
    credentials: LoginRequest,
    response: Response,
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Authenticate user and return tokens."""
    ...

@router.post("/refresh", response_model=dict)
async def refresh_token(
    request: Request,
    db: AsyncSession = Depends(get_db_session)
) -> dict:
    """Refresh access token using refresh token from cookie."""
    ...

@router.get("/me", response_model=dict)
async def get_current_user_profile(
    current_user: User = Depends(get_current_user)
) -> dict:
    """Get current user profile."""
    ...

@router.get("/users", response_model=dict)
async def list_users(
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(require_role(UserRole.ADMIN))
) -> dict:
    """List all users (admin only)."""
    ...

@router.patch("/users/{user_id}", response_model=dict)
async def update_user_role(
    user_id: str,
    role_data: dict,
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(require_role(UserRole.ADMIN))
) -> dict:
    """Update user role (admin only)."""
    ...

@router.delete("/users/{user_id}", status_code=204)
async def delete_user(
    user_id: str,
    db: AsyncSession = Depends(get_db_session),
    current_user: User = Depends(require_role(UserRole.ADMIN))
) -> None:
    """Delete user (admin only)."""
    ...
```

## Logic
1. Create FastAPI router with /api/auth prefix
2. Initialize AuthService and UserService instances
3. Implement register_user:
   - Validate admin role requirement
   - Create user via AuthService
   - Return user profile with success_response
4. Implement login:
   - Authenticate credentials via AuthService
   - Create access and refresh tokens
   - Set refresh token in httpOnly cookie
   - Return tokens and user profile
5. Implement refresh_token:
   - Extract refresh token from cookie
   - Verify token and create new access token
   - Return new access token
6. Implement get_current_user_profile:
   - Return current user from dependency
7. Implement list_users:
   - Get all users via UserService
   - Return with list_response format
8. Implement update_user_role:
   - Update user role via UserService
   - Return updated user profile
9. Implement delete_user:
   - Delete user via UserService
   - Return 204 No Content

## Verification
- [ ] All routes use appropriate HTTP methods and status codes
- [ ] Admin-only routes protected with require_role(UserRole.ADMIN)
- [ ] Login sets refresh token in httpOnly cookie
- [ ] Refresh token extracted from cookie header
- [ ] Error handling for invalid credentials, missing users
- [ ] Response format uses success_response and list_response helpers
- [ ] All routes have proper async/await usage

## LOC Estimate
~120 lines