# specs/001-auth/tasks/T-009.md

## Task: AuthService Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-002 (AuthService Contract Tests)
- **Blocks**: T-013 (AuthService Implementation)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | tests/test_auth_service_contract.py | AuthService interface and method signatures |

## Scope
- **CREATE**: `tests/test_auth_service_unit.py`

## Contract
```python
import pytest
from unittest.mock import AsyncMock, patch
from datetime import datetime, timedelta
from canvas.auth.service import AuthService
from canvas.models.user import User, UserRole

class TestAuthServiceUnit:
    async def test_register_user_success(self, db_session: AsyncSession) -> None:
        """Test successful user registration with password hashing."""
        ...
    
    async def test_register_user_duplicate_email(self, db_session: AsyncSession) -> None:
        """Test registration fails with duplicate email."""
        ...
    
    async def test_authenticate_user_valid_credentials(self, db_session: AsyncSession, test_user: User) -> None:
        """Test authentication with valid email and password."""
        ...
    
    async def test_authenticate_user_invalid_password(self, db_session: AsyncSession, test_user: User) -> None:
        """Test authentication fails with invalid password."""
        ...
    
    async def test_authenticate_user_nonexistent_email(self, db_session: AsyncSession) -> None:
        """Test authentication fails with nonexistent email."""
        ...
    
    async def test_create_access_token(self, test_user: User) -> None:
        """Test access token creation with 30min expiry."""
        ...
    
    async def test_create_refresh_token(self, test_user: User) -> None:
        """Test refresh token creation with 7 day expiry."""
        ...
    
    async def test_verify_token_valid(self, test_user: User) -> None:
        """Test token verification with valid JWT."""
        ...
    
    async def test_verify_token_expired(self, test_user: User) -> None:
        """Test token verification fails with expired JWT."""
        ...
    
    async def test_verify_token_invalid_signature(self) -> None:
        """Test token verification fails with invalid signature."""
        ...
    
    async def test_increment_failed_attempts(self, db_session: AsyncSession, test_user: User) -> None:
        """Test failed login attempt counter increments."""
        ...
    
    async def test_reset_failed_attempts(self, db_session: AsyncSession, test_user: User) -> None:
        """Test failed attempts reset on successful login."""
        ...
    
    async def test_is_account_locked_after_five_attempts(self, test_user: User) -> None:
        """Test account locks after 5 failed attempts."""
        ...
    
    async def test_is_account_locked_expires_after_15_minutes(self, test_user: User) -> None:
        """Test account lock expires after 15 minutes."""
        ...
    
    async def test_password_hashing_bcrypt_cost_12(self) -> None:
        """Test password hashing uses bcrypt with cost factor 12."""
        ...
```

## Logic
1. Import AuthService and User model
2. Create test fixtures for user data and database session
3. Test user registration with password hashing
4. Test authentication with valid/invalid credentials
5. Test JWT token creation with correct expiry times
6. Test token verification with valid/expired/invalid tokens
7. Test failed login attempt tracking and account locking
8. Test password hashing uses bcrypt cost factor 12
9. Verify all methods handle edge cases correctly

## Verification
- [ ] All test methods contain assert statements or pytest.raises
- [ ] Password hashing verified with bcrypt cost 12
- [ ] JWT tokens have correct expiry times
- [ ] Account locking works after 5 failed attempts
- [ ] Failed attempts reset on successful login
- [ ] Token verification handles all edge cases
- [ ] Database operations use async session correctly

## LOC Estimate
~200 lines