# specs/001-auth/tasks/T-015.md

## Task: Auth Dependencies Implementation

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-004 (Auth Dependencies Contract Tests), T-013 (AuthService Implementation)
- **Blocks**: T-016 (Auth Routes Implementation)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-004 | tests/test_auth_dependencies_contract.py | Dependency function signatures |
| T-013 | backend/canvas/auth/service.py | `from canvas.auth.service import AuthService` |

## Scope
- **MODIFY**: `backend/canvas/auth/dependencies.py`

## Contract
```python
from typing import Callable
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.service import AuthService
from canvas.models.user import User, UserRole
from canvas.db import get_db_session

security = HTTPBearer()
auth_service = AuthService()

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: AsyncSession = Depends(get_db_session)
) -> User:
    """Extract and validate user from JWT token."""
    ...

def require_role(*roles: UserRole) -> Callable[[User], User]:
    """Create dependency that requires user to have one of specified roles."""
    def role_checker(user: User = Depends(get_current_user)) -> User:
        """Check if current user has required role."""
        ...
    return role_checker
```

## Logic
1. Import HTTPBearer for token extraction
2. Import AuthService for token verification
3. Import get_db_session dependency from canvas.db
4. Implement get_current_user:
   - Extract token from Authorization header
   - Verify token using AuthService.verify_token
   - Get user by ID from token payload
   - Raise 401 if token invalid or user not found
   - Return authenticated user
5. Implement require_role factory:
   - Accept variable number of UserRole arguments
   - Return dependency function that checks user role
   - Raise 403 if user role not in allowed roles
   - Return user if authorized

## Verification
- [ ] get_current_user extracts token from Bearer header
- [ ] Token verification uses AuthService.verify_token
- [ ] Invalid tokens raise HTTPException with 401 status
- [ ] User lookup by ID from token payload
- [ ] require_role factory accepts multiple roles
- [ ] Role checking raises 403 for insufficient permissions
- [ ] Dependencies return User object for authorized requests

## LOC Estimate
~40 lines