# specs/001-auth/tasks/T-007.md

## Task: Rate Limiting Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-002 (AuthService Contract Tests)
- **Blocks**: T-016 (Auth Routes Implementation)
- **Requirements**: FR-005, FR-006

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | tests/test_auth_service_contract.py | AuthService interface for login testing |

## Scope
- **CREATE**: `tests/test_rate_limiting_integration.py`

## Contract
```python
import pytest
from httpx import AsyncClient
from unittest.mock import AsyncMock, patch

class TestRateLimitingIntegration:
    async def test_login_rate_limit_per_ip(self, client: AsyncClient) -> None:
        """Test login endpoint rate limiting: 5 attempts per IP per 15 minutes."""
        ...
    
    async def test_login_progressive_delays(self, client: AsyncClient) -> None:
        """Test progressive delays on failed login attempts: 1s, 2s, 4s, 8s, 16s."""
        ...
    
    async def test_refresh_rate_limit_per_user(self, client: AsyncClient, auth_headers: dict) -> None:
        """Test refresh endpoint rate limiting: 10 requests per user per minute."""
        ...
    
    async def test_register_rate_limit_per_admin(self, client: AsyncClient, admin_headers: dict) -> None:
        """Test register endpoint rate limiting: 2 requests per admin per minute."""
        ...
    
    async def test_rate_limit_headers_included(self, client: AsyncClient) -> None:
        """Test rate limit headers are included in responses."""
        ...
    
    async def test_rate_limit_reset_after_window(self, client: AsyncClient) -> None:
        """Test rate limits reset after time window expires."""
        ...
```

## Logic
1. Mock Redis backend for rate limiting storage
2. Create test client with rate limiting middleware
3. Test login endpoint with 5+ requests from same IP
4. Verify 429 status after limit exceeded
5. Test progressive delays on failed attempts
6. Test refresh token rate limiting per user
7. Test admin registration rate limiting
8. Verify rate limit headers in responses
9. Test rate limit window reset behavior

## Verification
- [ ] All test methods contain assert statements
- [ ] Rate limiting returns 429 after limits exceeded
- [ ] Progressive delays implemented correctly
- [ ] Rate limit headers included in responses
- [ ] Different endpoints have different limits
- [ ] Rate limits reset after time windows

## LOC Estimate
~120 lines