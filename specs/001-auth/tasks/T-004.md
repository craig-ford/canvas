# specs/001-auth/tasks/T-004.md

## Task: Auth Dependencies Contract Tests

## Type
contract-test

## Context
- **Phase**: Contracts & Interfaces
- **Builds on**: T-002 (AuthService)
- **Blocks**: T-005, T-006, T-015

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/models/user.py | User model, UserRole enum |
| T-002 | backend/canvas/auth/service.py | AuthService class |

## Scope
- **CREATE**: `backend/canvas/auth/dependencies.py`
- **CREATE**: `backend/tests/auth/test_auth_dependencies_contract.py`

## Contract
```python
from typing import Callable
from fastapi import Depends, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User, UserRole
from canvas.auth.service import AuthService
from canvas.db import get_db

security = HTTPBearer()
auth_service = AuthService()

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security),
    db: AsyncSession = Depends(get_db)
) -> User:
    """Extract and validate user from JWT token."""
    ...

def require_role(*roles: UserRole) -> Callable:
    """Dependency factory that requires user to have one of the specified roles."""
    async def checker(user: User = Depends(get_current_user)) -> User:
        """Check if current user has required role."""
        ...
    return checker
```

## Logic
1. Import User model and UserRole from T-001
2. Import AuthService from T-002
3. Import get_db dependency from infrastructure
4. Define HTTPBearer security scheme
5. Implement get_current_user dependency:
   - Extract JWT token from Authorization header
   - Verify token using AuthService
   - Get user from database by token payload
   - Raise 401 if token invalid or user not found
   - Return authenticated User
6. Implement require_role dependency factory:
   - Accept variable number of UserRole arguments
   - Return async function that checks user role
   - Raise 403 if user role not in allowed roles
   - Return user if authorized
7. Write contract tests verifying dependency behavior
8. Test valid token extraction and user retrieval
9. Test invalid token handling (401 errors)
10. Test role authorization (403 for insufficient permissions)

## Verification
- [ ] get_current_user dependency extracts user from JWT
- [ ] Invalid tokens raise HTTPException 401
- [ ] require_role factory accepts UserRole arguments
- [ ] Role checking raises HTTPException 403 for insufficient permissions
- [ ] Contract tests verify all error conditions
- [ ] All imports resolve correctly

## LOC Estimate
~90 lines