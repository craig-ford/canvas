# specs/001-auth/tasks/T-002.md

## Task: AuthService Contract Tests

## Type
contract-test

## Context
- **Phase**: Contracts & Interfaces
- **Builds on**: T-001 (User model)
- **Blocks**: T-004, T-005, T-009

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/models/user.py | User model, UserRole enum |

## Scope
- **CREATE**: `backend/canvas/auth/service.py`
- **CREATE**: `backend/tests/auth/test_auth_service_contract.py`

## Contract
```python
from typing import Optional
from uuid import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.user import User

class AuthService:
    """Authentication service handling user registration, login, and JWT tokens."""
    
    async def register_user(self, email: str, password: str, name: str, role: str, db: AsyncSession) -> User:
        """Register a new user with hashed password."""
        ...
    
    async def authenticate_user(self, email: str, password: str, db: AsyncSession) -> Optional[User]:
        """Authenticate user credentials, return User if valid, None if invalid."""
        ...
    
    async def create_access_token(self, user: User) -> str:
        """Create JWT access token with 30min expiry."""
        ...
    
    async def create_refresh_token(self, user: User) -> str:
        """Create JWT refresh token with 7 day expiry."""
        ...
    
    async def verify_token(self, token: str) -> Optional[dict]:
        """Verify JWT token and return payload, None if invalid/expired."""
        ...
    
    async def get_user_by_id(self, user_id: UUID, db: AsyncSession) -> Optional[User]:
        """Get user by ID."""
        ...
    
    async def increment_failed_attempts(self, email: str, db: AsyncSession) -> None:
        """Increment failed login attempts for user."""
        ...
    
    async def reset_failed_attempts(self, user: User, db: AsyncSession) -> None:
        """Reset failed login attempts to 0."""
        ...
    
    def is_account_locked(self, user: User) -> bool:
        """Check if account is currently locked due to failed attempts."""
        ...
```

## Logic
1. Import User model from T-001
2. Define AuthService class with all required methods
3. Use bcrypt for password hashing (cost factor 12)
4. Use python-jose for JWT creation/verification
5. Implement account locking after 5 failed attempts (15min lockout)
6. Write contract tests verifying method signatures and basic behavior
7. Test password hashing/verification
8. Test JWT token creation/verification
9. Test account locking logic

## Verification
- [ ] AuthService class defined with all methods
- [ ] Contract tests verify method signatures
- [ ] Password hashing uses bcrypt cost 12
- [ ] JWT tokens use HS256 algorithm
- [ ] Account locking logic implemented
- [ ] All contract tests pass

## LOC Estimate
~120 lines