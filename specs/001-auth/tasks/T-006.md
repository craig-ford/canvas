# specs/001-auth/tasks/T-006.md

## Task: User Management Routes Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2: Test Infrastructure
- **Builds on**: T-003 (UserService Contract Tests), T-004 (Auth Dependencies Contract Tests)
- **Blocks**: T-016 (Auth Routes Implementation)
- **Requirements**: FR-003, FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | canvas/__init__.py | 001A-infrastructure/T-006 | `from canvas import success_response, list_response` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/auth/user_service.py | UserService |
| T-004 | backend/canvas/auth/dependencies.py | get_current_user, require_role |
| T-001 | backend/canvas/models/user.py | User, UserRole |

## Scope
- **CREATE**: `backend/tests/auth/test_user_routes.py`

## Contract
```python
import pytest
from httpx import AsyncClient
from fastapi import status
from canvas.models.user import User, UserRole

class TestUserManagementRoutes:
    """Test admin user management endpoints with authorization."""
    
    async def test_get_users_admin_success(self, client: AsyncClient, admin_token: str):
        """Test admin can list all users."""
        response = await client.get("/api/users", headers={"Authorization": f"Bearer {admin_token}"})
        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert "data" in data
        assert isinstance(data["data"], list)
    
    async def test_get_users_non_admin_forbidden(self, client: AsyncClient, gm_token: str):
        """Test non-admin cannot list users."""
        response = await client.get("/api/users", headers={"Authorization": f"Bearer {gm_token}"})
        assert response.status_code == status.HTTP_403_FORBIDDEN
    
    async def test_get_users_no_auth_unauthorized(self, client: AsyncClient):
        """Test unauthenticated request returns 401."""
        response = await client.get("/api/users")
        assert response.status_code == status.HTTP_401_UNAUTHORIZED
    
    async def test_update_user_role_admin_success(self, client: AsyncClient, admin_token: str, sample_user: User):
        """Test admin can update user role."""
        response = await client.patch(
            f"/api/users/{sample_user.id}",
            json={"role": "admin"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert response.status_code == status.HTTP_200_OK
        data = response.json()
        assert data["data"]["role"] == "admin"
    
    async def test_update_user_role_non_admin_forbidden(self, client: AsyncClient, gm_token: str, sample_user: User):
        """Test non-admin cannot update user role."""
        response = await client.patch(
            f"/api/users/{sample_user.id}",
            json={"role": "admin"},
            headers={"Authorization": f"Bearer {gm_token}"}
        )
        assert response.status_code == status.HTTP_403_FORBIDDEN
    
    async def test_update_user_role_invalid_role(self, client: AsyncClient, admin_token: str, sample_user: User):
        """Test invalid role returns validation error."""
        response = await client.patch(
            f"/api/users/{sample_user.id}",
            json={"role": "invalid"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
    
    async def test_update_user_role_nonexistent_user(self, client: AsyncClient, admin_token: str):
        """Test updating nonexistent user returns 404."""
        from uuid import uuid4
        response = await client.patch(
            f"/api/users/{uuid4()}",
            json={"role": "admin"},
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert response.status_code == status.HTTP_404_NOT_FOUND
    
    async def test_delete_user_admin_success(self, client: AsyncClient, admin_token: str, sample_user: User):
        """Test admin can delete user."""
        response = await client.delete(
            f"/api/users/{sample_user.id}",
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert response.status_code == status.HTTP_204_NO_CONTENT
    
    async def test_delete_user_non_admin_forbidden(self, client: AsyncClient, gm_token: str, sample_user: User):
        """Test non-admin cannot delete user."""
        response = await client.delete(
            f"/api/users/{sample_user.id}",
            headers={"Authorization": f"Bearer {gm_token}"}
        )
        assert response.status_code == status.HTTP_403_FORBIDDEN
    
    async def test_delete_user_nonexistent_user(self, client: AsyncClient, admin_token: str):
        """Test deleting nonexistent user returns 404."""
        from uuid import uuid4
        response = await client.delete(
            f"/api/users/{uuid4()}",
            headers={"Authorization": f"Bearer {admin_token}"}
        )
        assert response.status_code == status.HTTP_404_NOT_FOUND
```

## Logic
1. Test GET /api/users with admin authorization
2. Test authorization failures for non-admin users
3. Test PATCH /api/users/{id} for role updates
4. Test DELETE /api/users/{id} for user deletion
5. Test error conditions (404, 422, 403, 401)
6. Use real HTTP client and JWT tokens
7. Verify response formats match API spec

## Verification
- [ ] All test methods have assert statements
- [ ] Authorization matrix tested (admin vs non-admin)
- [ ] Error conditions covered (404, 422, 403, 401)
- [ ] Response format validation included

## LOC Estimate
~65 lines