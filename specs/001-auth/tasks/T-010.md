# specs/001-auth/tasks/T-010.md

## Task: UserService Unit Tests

## Type
unit-test

## Context
- **Phase**: Phase 2: Test Infrastructure
- **Builds on**: T-003 (UserService Contract Tests)
- **Blocks**: T-014 (UserService Implementation)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | canvas/db.py | 001A-infrastructure/T-007 | `from canvas.db import get_db_session` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/auth/user_service.py | UserService |
| T-001 | backend/canvas/models/user.py | User, UserRole |

## Scope
- **CREATE**: `backend/tests/auth/test_user_service.py`

## Contract
```python
import pytest
from uuid import uuid4
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.user_service import UserService
from canvas.models.user import User, UserRole

class TestUserService:
    """Test UserService CRUD operations and role management."""
    
    async def test_list_users_returns_all_users(self, db_session: AsyncSession, user_service: UserService):
        """Test listing all users returns complete list."""
        assert len(await user_service.list_users(db_session)) >= 0
    
    async def test_update_user_role_changes_role(self, db_session: AsyncSession, user_service: UserService, sample_user: User):
        """Test updating user role changes the role field."""
        updated_user = await user_service.update_user_role(sample_user.id, UserRole.ADMIN, db_session)
        assert updated_user.role == UserRole.ADMIN
    
    async def test_update_user_role_nonexistent_raises_error(self, db_session: AsyncSession, user_service: UserService):
        """Test updating nonexistent user raises ValueError."""
        with pytest.raises(ValueError):
            await user_service.update_user_role(uuid4(), UserRole.ADMIN, db_session)
    
    async def test_delete_user_removes_user(self, db_session: AsyncSession, user_service: UserService, sample_user: User):
        """Test deleting user removes it from database."""
        await user_service.delete_user(sample_user.id, db_session)
        deleted_user = await user_service.get_user_by_email(sample_user.email, db_session)
        assert deleted_user is None
    
    async def test_delete_user_nonexistent_raises_error(self, db_session: AsyncSession, user_service: UserService):
        """Test deleting nonexistent user raises ValueError."""
        with pytest.raises(ValueError):
            await user_service.delete_user(uuid4(), db_session)
    
    async def test_get_user_by_email_case_insensitive(self, db_session: AsyncSession, user_service: UserService, sample_user: User):
        """Test email lookup is case-insensitive."""
        found_user = await user_service.get_user_by_email(sample_user.email.upper(), db_session)
        assert found_user is not None
        assert found_user.id == sample_user.id
    
    async def test_get_user_by_email_nonexistent_returns_none(self, db_session: AsyncSession, user_service: UserService):
        """Test looking up nonexistent email returns None."""
        found_user = await user_service.get_user_by_email("nonexistent@example.com", db_session)
        assert found_user is None
```

## Logic
1. Import UserService from T-003 contract
2. Import User model and UserRole from T-001
3. Test each UserService method with valid inputs
4. Test error conditions (nonexistent users)
5. Test edge cases (case-insensitive email lookup)
6. Use pytest fixtures for database session and sample data

## Verification
- [ ] All test methods have assert statements
- [ ] Error conditions tested with pytest.raises
- [ ] Edge cases covered (case sensitivity)
- [ ] Fixtures used for test data setup

## LOC Estimate
~45 lines