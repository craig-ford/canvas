# specs/001A-infrastructure/tasks/T-010.md

## Task: Docker Compose Setup

## Type
implementation

## Context
- **Phase**: Phase 3: Data Layer
- **Builds on**: T-005 (Docker Integration Tests), T-007 (Database Implementation)
- **Blocks**: None
- **Requirements**: FR-INFRA-001, FR-INFRA-002, FR-INFRA-003, FR-INFRA-004, FR-INFRA-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-005 | tests/test_docker.py | PostgreSQL service health check |
| T-007 | backend/canvas/db.py | Database connection |

## Requirements
- FR-INFRA-004

## Scope
- **CREATE**: `docker-compose.yml`
- **CREATE**: `backend/Dockerfile`
- **CREATE**: `frontend/Dockerfile`
- **CREATE**: `.env.dev`
- **CREATE**: `.env.prod`

## Contract
```yaml
# docker-compose.yml
services:
  db:
    image: postgres:18
    environment:
      POSTGRES_USER: canvas
      POSTGRES_PASSWORD: canvas_dev
      POSTGRES_DB: canvas
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U canvas"]
      interval: 5s
      timeout: 5s
      retries: 5
  
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    depends_on:
      db:
        condition: service_healthy
  
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"  # dev profile
      - "80:80"      # prod profile
    depends_on:
      backend:
        condition: service_healthy
```

## Logic
1. Create docker-compose.yml with db, backend, frontend services
2. Configure PostgreSQL service with health check using pg_isready
3. Set up service dependencies with health check conditions
4. Create backend Dockerfile with Python 3.12, install dependencies, run FastAPI
5. Create frontend Dockerfile with Node.js, multi-stage build for dev/prod
6. Configure dev and prod profiles with different port mappings
7. Set up named volume for PostgreSQL data persistence

## Verification
- [ ] PostgreSQL service has health check with pg_isready
- [ ] Backend depends on db service being healthy
- [ ] Frontend depends on backend service being healthy
- [ ] Dev profile exposes frontend on port 5173
- [ ] Prod profile exposes frontend on port 80
- [ ] Backend Dockerfile installs Python dependencies
- [ ] Frontend Dockerfile has multi-stage build

## LOC Estimate
~80 lines