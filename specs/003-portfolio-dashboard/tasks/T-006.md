# specs/003-portfolio-dashboard/tasks/T-006.md

## Task: PDFService Implementation

## Type
implementation

## Context
- **Phase**: Phase 4: Core Logic
- **Builds on**: T-002 (PDF Service Contract Tests)
- **Blocks**: T-008 (PDF export endpoint integration tests)
- **Requirements**: FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | backend/canvas/models/canvas.py | 002-canvas-management/T-003 | `from canvas.models.canvas import Canvas` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-002 | backend/canvas/pdf/test_service.py | PDFService contract interface |

## Scope
- **CREATE**: `backend/canvas/pdf/service.py`
- **CREATE**: `backend/canvas/pdf/templates/canvas.html`
- **CREATE**: `backend/canvas/pdf/__init__.py`

## Contract
```python
from uuid import UUID
from jinja2 import Environment, FileSystemLoader
from weasyprint import HTML
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.models.canvas import Canvas

class PDFService:
    def __init__(self, db: AsyncSession):
        self.db = db
        self.jinja_env = Environment(
            loader=FileSystemLoader('backend/canvas/pdf/templates')
        )
    
    async def export_canvas(self, canvas_id: UUID) -> bytes:
        """Export canvas as PDF with proper styling."""
        canvas = await self._get_canvas_with_relations(canvas_id)
        
        template = self.jinja_env.get_template("canvas.html")
        html_content = template.render(
            vbu_name=canvas.vbu.name,
            lifecycle_lane=canvas.lifecycle_lane,
            success_description=canvas.success_description,
            future_state_intent=canvas.future_state_intent,
            theses=canvas.theses,
            primary_constraint=canvas.primary_constraint
        )
        
        pdf_bytes = HTML(string=html_content).write_pdf()
        return pdf_bytes
    
    async def _get_canvas_with_relations(self, canvas_id: UUID) -> Canvas:
        """Get canvas with VBU and theses relations."""
        ...
```

## Logic
1. Import weasyprint, jinja2, SQLAlchemy dependencies
2. Initialize PDFService with database session and Jinja environment
3. Implement export_canvas method:
   - Query canvas with VBU and theses relations
   - Render HTML template with canvas data
   - Generate PDF using WeasyPrint
   - Return PDF bytes
4. Implement _get_canvas_with_relations helper method
5. Create canvas.html template with Canvas brand styling
6. Handle CanvasNotFoundError and PDFGenerationError exceptions

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass
- [ ] PDF template uses Barlow font and #008AB0 brand color
- [ ] WeasyPrint generates valid PDF bytes

## LOC Estimate
~120 lines