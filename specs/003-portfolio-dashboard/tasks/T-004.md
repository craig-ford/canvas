# specs/003-portfolio-dashboard/tasks/T-004.md

## Task: Health Indicator Database Schema

## Type
implementation

## Context
- **Phase**: Phase 3 - Data Layer
- **Builds on**: None
- **Blocks**: T-005
- **Requirements**: FR-001, FR-002

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | backend/canvas/models/canvas.py | 002-canvas-management/T-003 | Direct modification of Canvas model |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| None | None | None |

## Scope
- **MODIFY**: `backend/canvas/models/canvas.py`
- **CREATE**: `alembic/versions/add_health_indicator_cache.py`

## Contract
```python
# Addition to backend/canvas/models/canvas.py Canvas model
from sqlalchemy import Column, String, DateTime

class Canvas(Base, TimestampMixin):
    # ... existing fields ...
    health_indicator_cache = Column(String(20), nullable=True)
    health_computed_at = Column(DateTime(timezone=True), nullable=True)

# alembic/versions/add_health_indicator_cache.py
def upgrade():
    # Add health indicator cache columns
    op.add_column('canvases', sa.Column('health_indicator_cache', sa.String(20), nullable=True))
    op.add_column('canvases', sa.Column('health_computed_at', sa.DateTime(timezone=True), nullable=True))
    
    # Create trigger function for health indicator updates
    op.execute("""
        CREATE OR REPLACE FUNCTION update_canvas_health_indicator()
        RETURNS TRIGGER AS $$
        BEGIN
            UPDATE canvases 
            SET health_indicator_cache = (
                CASE 
                    WHEN EXISTS(SELECT 1 FROM proof_points pp JOIN theses t ON pp.thesis_id = t.id 
                               WHERE t.canvas_id = c.id AND pp.status = 'stalled') THEN 'At Risk'
                    WHEN NOT EXISTS(SELECT 1 FROM proof_points pp JOIN theses t ON pp.thesis_id = t.id 
                                   WHERE t.canvas_id = c.id AND pp.status != 'not_started') THEN 'Not Started'
                    WHEN EXISTS(SELECT 1 FROM proof_points pp JOIN theses t ON pp.thesis_id = t.id 
                               WHERE t.canvas_id = c.id AND pp.status = 'observed') 
                         AND NOT EXISTS(SELECT 1 FROM proof_points pp JOIN theses t ON pp.thesis_id = t.id 
                                       WHERE t.canvas_id = c.id AND pp.status = 'stalled') THEN 'On Track'
                    ELSE 'In Progress'
                END
            ),
            health_computed_at = NOW()
            FROM canvases c
            JOIN theses t ON t.canvas_id = c.id
            WHERE t.id = COALESCE(NEW.thesis_id, OLD.thesis_id);
            RETURN COALESCE(NEW, OLD);
        END;
        $$ LANGUAGE plpgsql;
    """)
    
    # Create trigger
    op.execute("""
        CREATE TRIGGER proof_point_health_update
            AFTER INSERT OR UPDATE OR DELETE ON proof_points
            FOR EACH ROW EXECUTE FUNCTION update_canvas_health_indicator();
    """)

def downgrade():
    op.execute("DROP TRIGGER IF EXISTS proof_point_health_update ON proof_points;")
    op.execute("DROP FUNCTION IF EXISTS update_canvas_health_indicator();")
    op.drop_column('canvases', 'health_computed_at')
    op.drop_column('canvases', 'health_indicator_cache')
```

## Logic
1. Add health_indicator_cache column to Canvas model (String(20), nullable)
2. Add health_computed_at column to Canvas model (DateTime with timezone, nullable)
3. Create Alembic migration to add columns to canvases table
4. Create PostgreSQL trigger function that computes health indicator based on proof point statuses
5. Create trigger that fires on proof_points INSERT/UPDATE/DELETE to update health cache
6. Health computation logic: stalled → "At Risk", all not_started → "Not Started", observed & no stalled → "On Track", else → "In Progress"

## Verification
- [ ] Migration runs without error
- [ ] Canvas model includes new columns
- [ ] Trigger function computes correct health indicators
- [ ] Trigger fires on proof point changes
- [ ] Health cache updates automatically

## LOC Estimate
~100 lines