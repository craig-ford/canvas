# specs/003-portfolio-dashboard/tasks/T-008.md

## Task: Canvas PDF Export Route

## Type
integration-test

## Context
- **Phase**: Phase 5: API Layer
- **Builds on**: T-006 (PDFService implementation)
- **Blocks**: Frontend PDF export functionality
- **Requirements**: FR-001, FR-002, FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user` |
| 002-canvas-management | backend/canvas/vbus/service.py | 002-canvas-management/T-012 | `from canvas.vbus.service import VBUService` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-006 | backend/canvas/pdf/service.py | PDFService class |

## Scope
- **CREATE**: `backend/canvas/vbus/test_pdf_routes.py`
- **MODIFY**: `backend/canvas/vbus/router.py` (add PDF export endpoint)

## Contract
```python
@router.get("/vbus/{vbu_id}/canvas/pdf")
async def export_canvas_pdf(
    vbu_id: UUID,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
) -> Response:
    """Export canvas as PDF with role-based access control.
    
    Returns:
        PDF file with proper Content-Type and filename headers
        
    Raises:
        404: VBU not found or access denied
        500: PDF generation failed
    """
    vbu = await vbu_service.get_by_id(vbu_id, current_user)
    if not vbu:
        raise HTTPException(status_code=404, detail="VBU not found")
    
    pdf_bytes = await pdf_service.export_canvas(vbu.canvas.id)
    
    return Response(
        content=pdf_bytes,
        media_type="application/pdf",
        headers={
            "Content-Disposition": f'attachment; filename="{vbu.name}_canvas.pdf"',
            "Content-Length": str(len(pdf_bytes))
        }
    )
```

## Logic
1. Import FastAPI dependencies, Response, HTTPException
2. Import PDFService from T-006
3. Create integration test file with real database
4. Test successful PDF export with proper headers
5. Test role-based access control (GM can only export own VBUs)
6. Test 404 response for non-existent VBU
7. Test 404 response when GM tries to access other's VBU
8. Test PDF generation error handling
9. Implement actual route in vbus/router.py
10. Verify Content-Type and Content-Disposition headers

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass
- [ ] Role-based access control enforced
- [ ] PDF response has correct headers
- [ ] Error cases return proper HTTP status codes

## LOC Estimate
~150 lines