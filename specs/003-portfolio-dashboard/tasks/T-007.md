# specs/003-portfolio-dashboard/tasks/T-007.md

## Task: Portfolio API Routes

## Type
implementation

## Context
- **Phase**: Phase 5 - API Layer
- **Builds on**: T-003, T-005
- **Blocks**: None
- **Requirements**: FR-001, FR-002

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 001-auth | backend/canvas/models/user.py | 001-auth/T-011 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/portfolio/router.py | Router definition and endpoint signatures |
| T-005 | backend/canvas/portfolio/service.py | PortfolioService implementation |
| T-001 | backend/canvas/portfolio/schemas.py | PortfolioFilters, PortfolioNotesRequest |

## Scope
- **MODIFY**: `backend/canvas/portfolio/router.py`
- **CREATE**: `tests/test_portfolio_routes.py`

## Contract
```python
# backend/canvas/portfolio/router.py implementation
from fastapi import APIRouter, Depends, Query, HTTPException
from typing import Optional
from uuid import UUID
from datetime import datetime, timezone
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.auth.dependencies import get_current_user, require_role
from canvas.models.user import User
from canvas.db import get_db
from canvas import success_response, list_response
from .schemas import PortfolioFilters, PortfolioNotesRequest
from .service import PortfolioService

router = APIRouter(prefix="/api/portfolio", tags=["portfolio"])

@router.get("/summary")
async def get_portfolio_summary(
    lane: Optional[str] = Query(None, description="Comma-separated lifecycle lanes"),
    gm_id: Optional[str] = Query(None, description="Comma-separated GM UUIDs"),
    health_status: Optional[str] = Query(None, description="Comma-separated health statuses"),
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db)
) -> dict:
    """Get portfolio summary with filtering"""
    try:
        # Parse and validate filters
        filters = PortfolioFilters()
        
        if lane:
            from .schemas import LifecycleLane
            filters.lane = [LifecycleLane(l.strip()) for l in lane.split(",")]
        
        if gm_id:
            filters.gm_id = [UUID(id.strip()) for id in gm_id.split(",")]
        
        if health_status:
            valid_statuses = ["Not Started", "In Progress", "On Track", "At Risk"]
            statuses = [s.strip() for s in health_status.split(",")]
            for status in statuses:
                if status not in valid_statuses:
                    raise HTTPException(
                        status_code=422, 
                        detail=f"Invalid health status: {status}. Valid values: {valid_statuses}"
                    )
            filters.health_status = statuses
        
        # Get portfolio summary
        portfolio_service = PortfolioService(db)
        summary = await portfolio_service.get_summary(current_user, filters)
        
        return list_response(
            data=[s.dict() for s in summary], 
            total=len(summary),
            page=1,
            per_page=25
        )
        
    except ValueError as e:
        raise HTTPException(status_code=422, detail=str(e))

@router.patch("/notes")
async def update_portfolio_notes(
    request: PortfolioNotesRequest,
    current_user: User = Depends(require_role("admin")),
    db: AsyncSession = Depends(get_db)
) -> dict:
    """Update portfolio notes (admin only)"""
    portfolio_service = PortfolioService(db)
    await portfolio_service.update_portfolio_notes(request.notes, current_user)
    
    return success_response({
        "notes": request.notes,
        "updated_at": datetime.now(timezone.utc).isoformat()
    })
```

## Logic
1. Implement GET /api/portfolio/summary endpoint with query parameter parsing
2. Validate and parse comma-separated filter parameters (lane, gm_id, health_status)
3. Handle validation errors with 422 status and detailed error messages
4. Create PortfolioService instance and call get_summary with filters
5. Return data in standard list_response envelope format
6. Implement PATCH /api/portfolio/notes endpoint with admin-only access
7. Use require_role("admin") dependency for automatic authorization
8. Call portfolio service to update notes and return success response
9. Handle service exceptions and convert to appropriate HTTP responses

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass
- [ ] Query parameter parsing works correctly
- [ ] Validation errors return 422 with details
- [ ] Admin-only access enforced for notes endpoint
- [ ] Response envelopes follow standard format

## LOC Estimate
~200 lines