# specs/003-portfolio-dashboard/tasks/T-003.md

## Task: Portfolio API Contract Tests

## Type
contract-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-001
- **Blocks**: T-007
- **Requirements**: FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |
| 002-canvas-management | backend/canvas/models/user.py | 001-auth/T-011 | `from canvas.models.user import User` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/portfolio/schemas.py | VBUSummary, PortfolioFilters, PortfolioNotesRequest |
| T-001 | backend/canvas/portfolio/service.py | PortfolioService |

## Scope
- **CREATE**: `backend/canvas/portfolio/router.py`
- **CREATE**: `tests/test_portfolio_api.py`

## Contract
```python
# backend/canvas/portfolio/router.py
from fastapi import APIRouter, Depends, Query
from typing import Optional
from uuid import UUID
from canvas.auth.dependencies import get_current_user, require_role
from canvas.models.user import User
from canvas import success_response, list_response
from .schemas import PortfolioFilters, PortfolioNotesRequest
from .service import PortfolioService

router = APIRouter(prefix="/portfolio", tags=["portfolio"])

@router.get("/summary")
async def get_portfolio_summary(
    lane: Optional[str] = Query(None, description="Comma-separated lifecycle lanes"),
    gm_id: Optional[str] = Query(None, description="Comma-separated GM UUIDs"),
    health_status: Optional[str] = Query(None, description="Comma-separated health statuses"),
    current_user: User = Depends(get_current_user)
) -> dict:
    """Get portfolio summary with filtering"""
    ...

@router.patch("/notes")
async def update_portfolio_notes(
    request: PortfolioNotesRequest,
    current_user: User = Depends(require_role("admin"))
) -> dict:
    """Update portfolio notes (admin only)"""
    ...
```

## Logic
1. Create FastAPI router with portfolio endpoints
2. Define GET /api/portfolio/summary with query parameter filtering
3. Define PATCH /api/portfolio/notes with admin-only access
4. Write contract tests for endpoint signatures and response formats
5. Test role-based access control (admin sees all, GM sees own, viewer sees all read-only)
6. Test query parameter validation and filtering logic
7. Test error responses for unauthorized access and invalid parameters

## Verification
- [ ] Imports resolve without error
- [ ] Type hints complete
- [ ] Tests pass
- [ ] Router endpoints defined with proper dependencies
- [ ] Response envelopes follow standard format
- [ ] Role-based access control enforced

## LOC Estimate
~200 lines