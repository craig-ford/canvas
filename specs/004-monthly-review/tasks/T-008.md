# specs/004-monthly-review/tasks/T-008.md

## Task: Review API Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-003 (ReviewService interface), T-007 (service integration tests)
- **Blocks**: T-009 (validation tests)
- **Requirements**: FR-003, FR-004

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001-auth | backend/canvas/auth/dependencies.py | 001-auth/T-015 | `from canvas.auth.dependencies import get_current_user, require_role` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/reviews/service.py | ReviewService interface |
| T-007 | backend/tests/reviews/test_service_integration.py | Service test patterns |

## Scope
- **CREATE**: `backend/tests/reviews/test_api_integration.py`

## Contract
```python
import pytest
from httpx import AsyncClient
from fastapi import status
from uuid import uuid4
from datetime import date

class TestReviewAPIIntegration:
    async def test_list_reviews_admin_access_all_canvases(self, client: AsyncClient, admin_token, canvas_a, canvas_b):
        """Test admin can list reviews for any canvas"""
        resp = await client.get(f"/api/reviews?canvas_id={canvas_a.id}", headers={"Authorization": f"Bearer {admin_token}"})
        assert resp.status_code == status.HTTP_200_OK
        resp_b = await client.get(f"/api/reviews?canvas_id={canvas_b.id}", headers={"Authorization": f"Bearer {admin_token}"})
        assert resp_b.status_code == status.HTTP_200_OK

    async def test_list_reviews_gm_access_own_canvas_only(self, client: AsyncClient, gm_token, own_canvas, other_canvas):
        """Test GM can only list reviews for own VBU canvas"""
        resp = await client.get(f"/api/reviews?canvas_id={own_canvas.id}", headers={"Authorization": f"Bearer {gm_token}"})
        assert resp.status_code == status.HTTP_200_OK
        resp_other = await client.get(f"/api/reviews?canvas_id={other_canvas.id}", headers={"Authorization": f"Bearer {gm_token}"})
        assert resp_other.status_code == status.HTTP_403_FORBIDDEN

    async def test_list_reviews_viewer_access_all_readonly(self, client: AsyncClient, viewer_token, any_canvas):
        """Test viewer can list reviews for any canvas (read-only)"""
        resp = await client.get(f"/api/reviews?canvas_id={any_canvas.id}", headers={"Authorization": f"Bearer {viewer_token}"})
        assert resp.status_code == status.HTTP_200_OK

    async def test_create_review_admin_any_canvas(self, client: AsyncClient, admin_token, any_canvas):
        """Test admin can create review for any canvas"""
        payload = {"canvas_id": str(any_canvas.id), "review_date": str(date.today()), "commitments": [{"text": "Test", "order": 1}]}
        resp = await client.post("/api/reviews", json=payload, headers={"Authorization": f"Bearer {admin_token}"})
        assert resp.status_code == status.HTTP_201_CREATED

    async def test_create_review_gm_own_canvas_only(self, client: AsyncClient, gm_token, own_canvas, other_canvas):
        """Test GM can only create review for own VBU canvas"""
        payload = {"canvas_id": str(own_canvas.id), "review_date": str(date.today()), "commitments": [{"text": "Test", "order": 1}]}
        resp = await client.post("/api/reviews", json=payload, headers={"Authorization": f"Bearer {gm_token}"})
        assert resp.status_code == status.HTTP_201_CREATED
        payload_other = {"canvas_id": str(other_canvas.id), "review_date": str(date.today()), "commitments": [{"text": "Test", "order": 1}]}
        resp_other = await client.post("/api/reviews", json=payload_other, headers={"Authorization": f"Bearer {gm_token}"})
        assert resp_other.status_code == status.HTTP_403_FORBIDDEN

    async def test_create_review_viewer_forbidden(self, client: AsyncClient, viewer_token, any_canvas):
        """Test viewer cannot create reviews (403 Forbidden)"""
        payload = {"canvas_id": str(any_canvas.id), "review_date": str(date.today()), "commitments": [{"text": "Test", "order": 1}]}
        resp = await client.post("/api/reviews", json=payload, headers={"Authorization": f"Bearer {viewer_token}"})
        assert resp.status_code == status.HTTP_403_FORBIDDEN

    async def test_get_review_authorization_matrix(self, client: AsyncClient, admin_token, gm_token, viewer_token, review):
        """Test get single review follows same authorization as list"""
        resp_admin = await client.get(f"/api/reviews/{review.id}", headers={"Authorization": f"Bearer {admin_token}"})
        assert resp_admin.status_code == status.HTTP_200_OK
        resp_viewer = await client.get(f"/api/reviews/{review.id}", headers={"Authorization": f"Bearer {viewer_token}"})
        assert resp_viewer.status_code == status.HTTP_200_OK

    async def test_unauthorized_access_returns_401(self, client: AsyncClient, any_canvas):
        """Test missing JWT returns 401 Unauthorized"""
        resp = await client.get(f"/api/reviews?canvas_id={any_canvas.id}")
        assert resp.status_code == status.HTTP_401_UNAUTHORIZED
```

## Logic
1. Import FastAPI test client and auth dependencies
2. Test authorization matrix for all three endpoints
3. Test admin access to all canvases
4. Test GM access restricted to own VBUs
5. Test viewer read-only access
6. Test 401/403 error responses
7. Use real HTTP requests, real auth tokens

## Verification
- [ ] All test methods contain assert statements
- [ ] Authorization matrix fully tested
- [ ] HTTP status codes verified
- [ ] Real JWT tokens used
- [ ] Error responses tested

## LOC Estimate
~100 lines