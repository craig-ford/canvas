# specs/004-monthly-review/tasks/T-006.md

## Task: Canvas Update Trigger Contract

## Type
contract-test

## Context
- **Phase**: Phase 3 - Data Layer
- **Builds on**: T-001 (MonthlyReview model), T-005 (migration)
- **Blocks**: T-007 (ReviewService integration tests)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-001 | backend/canvas/models/monthly_review.py | MonthlyReview model |
| T-005 | alembic/versions/xxx_monthly_reviews.py | Migration creates tables |

## Scope
- **CREATE**: `alembic/versions/xxx_canvas_trigger.py`

## Contract
```sql
CREATE OR REPLACE FUNCTION update_canvas_currently_testing()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.currently_testing_type IS NOT NULL AND NEW.currently_testing_id IS NOT NULL THEN
        UPDATE canvases 
        SET currently_testing_type = NEW.currently_testing_type,
            currently_testing_id = NEW.currently_testing_id,
            updated_at = NOW()
        WHERE id = NEW.canvas_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_canvas_currently_testing
    AFTER INSERT ON monthly_reviews
    FOR EACH ROW
    EXECUTE FUNCTION update_canvas_currently_testing();
```

## Logic
1. Create Alembic migration file for trigger
2. Define PostgreSQL function that updates canvas currently_testing fields
3. Create AFTER INSERT trigger on monthly_reviews table
4. Function only updates when both type and id are NOT NULL
5. Updates canvas.updated_at timestamp for audit trail

## Verification
- [ ] Migration runs without error
- [ ] Trigger function created in database
- [ ] Trigger attached to monthly_reviews table
- [ ] Canvas update occurs atomically with review insert

## LOC Estimate
~30 lines