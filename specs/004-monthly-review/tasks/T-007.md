# specs/004-monthly-review/tasks/T-007.md

## Task: ReviewService Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-003 (ReviewService interface), T-005 (migration), T-006 (trigger)
- **Blocks**: T-008 (API integration tests), T-009 (validation tests)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | backend/canvas/attachments/service.py | 002-canvas-management/T-013 | `from canvas.attachments.service import AttachmentService` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/reviews/service.py | ReviewService interface |
| T-005 | alembic/versions/xxx_monthly_reviews.py | Database tables |
| T-006 | alembic/versions/xxx_canvas_trigger.py | Canvas update trigger |

## Scope
- **CREATE**: `backend/tests/reviews/test_service_integration.py`

## Contract
```python
import pytest
from uuid import uuid4
from datetime import date, datetime
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.reviews.service import ReviewService
from canvas.models.monthly_review import MonthlyReview
from canvas.models.commitment import Commitment

class TestReviewServiceIntegration:
    async def test_create_review_with_commitments(self, db_session: AsyncSession, sample_canvas, sample_user):
        """Test creating review with commitments updates canvas atomically"""
        
    async def test_list_reviews_ordered_by_date(self, db_session: AsyncSession, sample_canvas):
        """Test reviews returned in review_date DESC, created_at DESC order"""
        
    async def test_create_review_updates_canvas_currently_testing(self, db_session: AsyncSession, sample_canvas, sample_thesis):
        """Test trigger updates canvas.currently_testing_type and currently_testing_id"""
        
    async def test_attachment_linking_integration(self, db_session: AsyncSession, sample_canvas, sample_user):
        """Test linking pre-uploaded attachments to review via AttachmentService"""
        
    async def test_validate_currently_testing_belongs_to_canvas(self, db_session: AsyncSession, sample_canvas, other_canvas_thesis):
        """Test validation prevents selecting thesis/proof_point from different canvas"""
        
    async def test_get_review_with_relationships(self, db_session: AsyncSession, sample_review):
        """Test get_review loads commitments and attachments"""
```

## Logic
1. Import ReviewService and related models
2. Test create_review with real database transaction
3. Verify canvas currently_testing update via trigger
4. Test attachment linking with AttachmentService integration
5. Test validation of currently_testing selection
6. Test review listing with proper ordering
7. Use real PostgreSQL, no mocks

## Verification
- [ ] All test methods contain assert statements
- [ ] Tests use real database session
- [ ] AttachmentService integration tested
- [ ] Canvas trigger behavior verified
- [ ] Validation rules tested with real data

## LOC Estimate
~120 lines