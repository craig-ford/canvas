# specs/004-monthly-review/tasks/T-007.md

## Task: ReviewService Integration Tests

## Type
integration-test

## Context
- **Phase**: Phase 2 - Test Infrastructure
- **Builds on**: T-003 (ReviewService interface), T-005 (migration), T-006 (trigger)
- **Blocks**: T-008 (API integration tests), T-009 (validation tests)
- **Requirements**: FR-001, FR-002

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | backend/canvas/attachments/service.py | 002-canvas-management/T-013 | `from canvas.attachments.service import AttachmentService` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-003 | backend/canvas/reviews/service.py | ReviewService interface |
| T-005 | alembic/versions/xxx_monthly_reviews.py | Database tables |
| T-006 | alembic/versions/xxx_canvas_trigger.py | Canvas update trigger |

## Scope
- **CREATE**: `backend/tests/reviews/test_service_integration.py`

## Contract
```python
import pytest
from uuid import uuid4
from datetime import date, datetime
from sqlalchemy.ext.asyncio import AsyncSession
from canvas.reviews.service import ReviewService
from canvas.models.monthly_review import MonthlyReview
from canvas.models.commitment import Commitment

class TestReviewServiceIntegration:
    async def test_create_review_with_commitments(self, db_session: AsyncSession, sample_canvas, sample_user):
        """Test creating review with commitments updates canvas atomically"""
        service = ReviewService(db_session)
        review = await service.create_review(canvas_id=sample_canvas.id, created_by=sample_user.id, review_date=date.today(), commitments=[{"text": "Test commitment", "order": 1}])
        assert review is not None
        assert review.canvas_id == sample_canvas.id
        assert len(review.commitments) == 1

    async def test_list_reviews_ordered_by_date(self, db_session: AsyncSession, sample_canvas):
        """Test reviews returned in review_date DESC, created_at DESC order"""
        service = ReviewService(db_session)
        reviews = await service.list_reviews(canvas_id=sample_canvas.id)
        assert isinstance(reviews, list)
        assert all(reviews[i].review_date >= reviews[i + 1].review_date for i in range(len(reviews) - 1))

    async def test_create_review_updates_canvas_currently_testing(self, db_session: AsyncSession, sample_canvas, sample_thesis):
        """Test trigger updates canvas.currently_testing_type and currently_testing_id"""
        service = ReviewService(db_session)
        review = await service.create_review(canvas_id=sample_canvas.id, created_by=sample_canvas.vbu.gm_id, review_date=date.today(), currently_testing_type="thesis", currently_testing_id=sample_thesis.id, commitments=[{"text": "c1", "order": 1}])
        await db_session.refresh(sample_canvas)
        assert sample_canvas.currently_testing_type == "thesis"
        assert sample_canvas.currently_testing_id == sample_thesis.id

    async def test_attachment_linking_integration(self, db_session: AsyncSession, sample_canvas, sample_user):
        """Test linking pre-uploaded attachments to review via AttachmentService"""
        service = ReviewService(db_session)
        review = await service.create_review(canvas_id=sample_canvas.id, created_by=sample_user.id, review_date=date.today(), attachment_ids=[], commitments=[{"text": "c1", "order": 1}])
        assert review is not None
        assert review.attachments == []

    async def test_validate_currently_testing_belongs_to_canvas(self, db_session: AsyncSession, sample_canvas, other_canvas_thesis):
        """Test validation prevents selecting thesis/proof_point from different canvas"""
        service = ReviewService(db_session)
        with pytest.raises(ValueError, match="does not belong to canvas"):
            await service.create_review(canvas_id=sample_canvas.id, created_by=sample_canvas.vbu.gm_id, review_date=date.today(), currently_testing_type="thesis", currently_testing_id=other_canvas_thesis.id, commitments=[{"text": "c1", "order": 1}])

    async def test_get_review_with_relationships(self, db_session: AsyncSession, sample_review):
        """Test get_review loads commitments and attachments"""
        service = ReviewService(db_session)
        review = await service.get_review(sample_review.id)
        assert review is not None
        assert hasattr(review, "commitments")
        assert hasattr(review, "attachments")
```

## Logic
1. Import ReviewService and related models
2. Test create_review with real database transaction
3. Verify canvas currently_testing update via trigger
4. Test attachment linking with AttachmentService integration
5. Test validation of currently_testing selection
6. Test review listing with proper ordering
7. Use real PostgreSQL, no mocks

## Verification
- [ ] All test methods contain assert statements
- [ ] Tests use real database session
- [ ] AttachmentService integration tested
- [ ] Canvas trigger behavior verified
- [ ] Validation rules tested with real data

## LOC Estimate
~120 lines