# specs/004-monthly-review/tasks/T-001.md

## Task: MonthlyReview Model Contract

## Type
contract-test

## Context
- **Phase**: Contracts & Interfaces
- **Builds on**: None
- **Blocks**: T-002, T-003, T-004, T-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 001A-infrastructure | backend/canvas/models/__init__.py | 001A-infrastructure/T-006 | `from canvas.models import TimestampMixin` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| None | None | None |

## Scope
- **CREATE**: `backend/canvas/models/monthly_review.py`

## Contract
```python
from sqlalchemy import Column, Date, Text, ForeignKey, Enum, Index, UniqueConstraint, CheckConstraint
from sqlalchemy.dialects.postgresql import UUID
from sqlalchemy.orm import relationship
from canvas.models import Base, TimestampMixin

class MonthlyReview(Base, TimestampMixin):
    __tablename__ = "monthly_reviews"
    
    canvas_id = Column(UUID(as_uuid=True), ForeignKey("canvases.id", ondelete="CASCADE"), nullable=False)
    review_date = Column(Date, nullable=False)
    what_moved = Column(Text, nullable=True)
    what_learned = Column(Text, nullable=True)
    what_threatens = Column(Text, nullable=True)
    currently_testing_type = Column(Enum("thesis", "proof_point", name="testing_type"), nullable=True)
    currently_testing_id = Column(UUID(as_uuid=True), nullable=True)
    created_by = Column(UUID(as_uuid=True), ForeignKey("users.id", ondelete="RESTRICT"), nullable=False)
    
    # Relationships
    canvas = relationship("Canvas", back_populates="monthly_reviews")
    commitments = relationship("Commitment", back_populates="monthly_review", cascade="all, delete-orphan")
    attachments = relationship("Attachment", back_populates="monthly_review", cascade="all, delete-orphan")
    created_by_user = relationship("User")
    
    # Constraints
    __table_args__ = (
        UniqueConstraint('canvas_id', 'review_date', name='uq_monthly_reviews_canvas_date'),
        CheckConstraint("currently_testing_type IN ('thesis', 'proof_point') OR currently_testing_type IS NULL"),
        Index('ix_monthly_reviews_canvas_id', 'canvas_id'),
        Index('ix_monthly_reviews_review_date', 'review_date'),
        Index('ix_monthly_reviews_created_by', 'created_by'),
    )
```

## Logic
1. Import SQLAlchemy components and TimestampMixin
2. Define MonthlyReview class inheriting Base and TimestampMixin
3. Add table name and columns with proper types and constraints
4. Define relationships to Canvas, Commitment, Attachment, User
5. Add table-level constraints and indexes

## Verification
- [ ] Imports resolve without error
- [ ] Model has all required columns with correct types
- [ ] Relationships defined with proper back_populates
- [ ] Unique constraint on canvas_id + review_date
- [ ] Indexes created for performance

## LOC Estimate
~35 lines