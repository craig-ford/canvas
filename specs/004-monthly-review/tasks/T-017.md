# specs/004-monthly-review/tasks/T-017.md

## Task: Auto-save and File Upload

## Type
implementation

## Context
- **Phase**: Phase 6 - UI
- **Builds on**: T-015 (Review wizard UI)
- **Blocks**: T-018 (End-to-end integration)
- **Requirements**: FR-005

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | frontend/src/components/FileUpload.tsx | 002-canvas-management/T-011 | `import { FileUpload } from '../components/FileUpload'` |
| 002-canvas-management | frontend/src/hooks/useAttachments.ts | 002-canvas-management/T-011 | `import { useAttachments } from '../hooks/useAttachments'` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-015 | frontend/src/reviews/ReviewWizard.tsx | ReviewWizard component structure |

## Scope
- **MODIFY**: `frontend/src/reviews/ReviewWizard.tsx`
- **CREATE**: `frontend/src/reviews/hooks/useAutoSave.ts`
- **CREATE**: `frontend/src/reviews/components/FileUploadStep.tsx`

## Contract
```typescript
// useAutoSave.ts
import { useEffect, useRef } from 'react'
import { apiClient } from '../../api/client'

interface AutoSaveOptions {
  data: any
  canvasId: string
  interval?: number
  onSave?: (success: boolean) => void
}

export const useAutoSave = ({ data, canvasId, interval = 30000, onSave }: AutoSaveOptions) => {
  const timeoutRef = useRef<NodeJS.Timeout>()
  const lastSavedRef = useRef<string>('')
  
  const saveDraft = async () => {
    const currentData = JSON.stringify(data)
    if (currentData === lastSavedRef.current) return
    
    try {
      await apiClient.post(`/api/canvases/${canvasId}/reviews/draft`, data)
      lastSavedRef.current = currentData
      onSave?.(true)
    } catch (error) {
      onSave?.(false)
    }
  }
  
  useEffect(() => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current)
    timeoutRef.current = setTimeout(saveDraft, interval)
    
    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current)
    }
  }, [data, interval])
  
  return { saveDraft }
}

// FileUploadStep.tsx
import React from 'react'
import { FileUpload } from '../../components/FileUpload'
import { useAttachments } from '../../hooks/useAttachments'

interface FileUploadStepProps {
  attachmentIds: string[]
  onAttachmentsChange: (ids: string[]) => void
}

export const FileUploadStep: React.FC<FileUploadStepProps> = ({ 
  attachmentIds, 
  onAttachmentsChange 
}) => {
  const { uploadFile, deleteFile, attachments } = useAttachments()
  
  const handleFileUpload = async (files: File[]) => {
    const uploadPromises = files.map(file => uploadFile(file, 'monthly_review'))
    const results = await Promise.all(uploadPromises)
    const newIds = results.filter(Boolean).map(result => result.id)
    onAttachmentsChange([...attachmentIds, ...newIds])
  }
  
  const handleFileRemove = async (attachmentId: string) => {
    await deleteFile(attachmentId)
    onAttachmentsChange(attachmentIds.filter(id => id !== attachmentId))
  }
  
  return (
    <div className="space-y-4">
      <h3 className="text-lg font-medium">Attachments (optional)</h3>
      <FileUpload
        onFilesSelected={handleFileUpload}
        maxFiles={10}
        maxSize={10 * 1024 * 1024}
        acceptedTypes={['application/pdf', 'application/msword', 'image/png', 'image/jpeg']}
      />
      
      {attachments.length > 0 && (
        <div className="space-y-2">
          <h4 className="font-medium">Uploaded Files</h4>
          {attachments.map(attachment => (
            <div key={attachment.id} className="flex items-center justify-between p-2 border rounded">
              <span>{attachment.filename} ({(attachment.size_bytes / 1024 / 1024).toFixed(1)} MB)</span>
              <button 
                onClick={() => handleFileRemove(attachment.id)}
                className="text-red-600 hover:text-red-800"
              >
                Remove
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}

// Modified ReviewWizard.tsx additions
export const ReviewWizard: React.FC = () => {
  // ... existing state ...
  const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle')
  
  const { saveDraft } = useAutoSave({
    data: reviewData,
    canvasId: vbuId!,
    onSave: (success) => setSaveStatus(success ? 'saved' : 'error')
  })
  
  const handleManualSave = async () => {
    setSaveStatus('saving')
    await saveDraft()
  }
  
  return (
    <div className="max-w-4xl mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Monthly Review</h1>
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            {saveStatus === 'saving' && <span className="text-blue-600">Saving...</span>}
            {saveStatus === 'saved' && <span className="text-green-600">Saved</span>}
            {saveStatus === 'error' && <span className="text-red-600">Save failed</span>}
          </div>
          <button onClick={handleManualSave} className="px-4 py-2 border rounded">
            Save Draft
          </button>
        </div>
      </div>
      
      <StepIndicator currentStep={currentStep} totalSteps={4} />
      
      {currentStep === 1 && (
        <div className="space-y-6">
          <WhatMovedStep data={reviewData} onChange={setReviewData} />
          <FileUploadStep 
            attachmentIds={reviewData.attachment_ids}
            onAttachmentsChange={(ids) => setReviewData({...reviewData, attachment_ids: ids})}
          />
        </div>
      )}
      
      {/* ... other steps ... */}
    </div>
  )
}
```

## Logic
1. Create useAutoSave hook with configurable interval and change detection
2. Implement draft saving API endpoint integration
3. Add save status indicators (saving, saved, error states)
4. Create FileUploadStep component using shared FileUpload component
5. Integrate file upload with attachment management hooks
6. Add manual save button for user control
7. Modify ReviewWizard to include auto-save and file upload functionality
8. Handle file removal and attachment state management

## Verification
- [ ] Auto-save triggers every 30 seconds when data changes
- [ ] Save status indicators show current state accurately
- [ ] File upload integrates with existing AttachmentService
- [ ] Manual save button works independently of auto-save
- [ ] File removal updates attachment state correctly

## LOC Estimate
~200 lines