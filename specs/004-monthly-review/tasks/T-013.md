# specs/004-monthly-review/tasks/T-013.md

## Task: ReviewService Implementation

## Type
implementation

## Context
- **Phase**: Phase 4 - Core Logic
- **Builds on**: T-010 (ReviewService Unit Tests)
- **Blocks**: T-014 (Review API routes)

## Predecessors

### Cross-Feature
| Feature | File | Task | Import Statement |
|---------|------|------|------------------|
| 002-canvas-management | backend/canvas/models/canvas.py | 002-canvas-management/T-003 | `from canvas.models.canvas import Canvas` |
| 002-canvas-management | backend/canvas/models/thesis.py | 002-canvas-management/T-003 | `from canvas.models.thesis import Thesis` |
| 002-canvas-management | backend/canvas/models/proof_point.py | 002-canvas-management/T-003 | `from canvas.models.proof_point import ProofPoint` |
| 002-canvas-management | backend/canvas/models/attachment.py | 002-canvas-management/T-003 | `from canvas.models.attachment import Attachment` |

### Within Feature
| Task | File | What This Task Imports |
|------|------|------------------------|
| T-010 | backend/tests/reviews/test_service_unit.py | ReviewService interface contract |

## Scope
- **MODIFY**: `backend/canvas/reviews/service.py`

## Contract
```python
from typing import List, Dict, Any
from uuid import UUID
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, update
from sqlalchemy.orm import selectinload
from fastapi import HTTPException
from canvas.models.monthly_review import MonthlyReview
from canvas.models.commitment import Commitment
from canvas.models.thesis import Thesis
from canvas.models.proof_point import ProofPoint
from canvas.models.attachment import Attachment

class ReviewService:
    def __init__(self, db: AsyncSession):
        self.db = db
    
    async def list_reviews(self, canvas_id: UUID) -> List[MonthlyReview]:
        """List reviews for canvas, ordered by review_date DESC, created_at DESC"""
        ...
    
    async def create_review(self, canvas_id: UUID, review_data: Dict[str, Any], created_by: UUID) -> MonthlyReview:
        """Create review with commitments, update canvas currently_testing atomically"""
        ...
    
    async def get_review(self, review_id: UUID) -> MonthlyReview:
        """Get single review with commitments and attachments"""
        ...
        
    async def get_canvas_options(self, canvas_id: UUID) -> Dict[str, Any]:
        """Get theses and proof points for currently testing selection"""
        ...
    
    async def _validate_currently_testing(self, canvas_id: UUID, testing_type: str, testing_id: UUID) -> None:
        """Validate selected thesis/proof point belongs to canvas"""
        ...
    
    async def _link_attachments(self, review_id: UUID, attachment_ids: List[UUID]) -> None:
        """Link pre-uploaded attachments to review"""
        ...
```

## Logic
1. Import required SQLAlchemy, FastAPI, and model dependencies
2. Implement ReviewService.__init__ with AsyncSession dependency
3. Implement list_reviews with proper ordering and eager loading
4. Implement create_review with atomic transaction and validation
5. Implement get_review with error handling for not found
6. Implement get_canvas_options returning hierarchical structure
7. Implement _validate_currently_testing for thesis/proof point validation
8. Implement _link_attachments for attachment association

## Verification
- [ ] All methods have real implementation logic, not pass statements
- [ ] Async/await used correctly for database operations
- [ ] Transactions used for atomic operations in create_review
- [ ] HTTPException raised with appropriate status codes
- [ ] Eager loading used for relationships to avoid N+1 queries

## LOC Estimate
~120 lines